# Case Linkage System - Visual Architecture & Flow

## System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     DOCTOR REPORT PAGE                          â”‚
â”‚                  (templates/doctor/report.html)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Form Submission Handler        â”‚
         â”‚  (submitExperience function)    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚                   â”‚
                  â–¼                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Extract Form Dataâ”‚  â”‚ Close Modal      â”‚
        â”‚ (Drug, Symptoms)â”‚  â”‚ (If shown)       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  POST /api/cases/match     â”‚â—„â”€â”€â”€ LOCAL_API (http://localhost:5000)
    â”‚  (Case Matching Service)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  pv_backend/services/      â”‚
    â”‚  case_matching.py          â”‚
    â”‚                            â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚ CaseMatchingEngine   â”‚  â”‚
    â”‚  â”‚                      â”‚  â”‚
    â”‚  â”‚ â€¢ Text Similarity    â”‚  â”‚
    â”‚  â”‚ â€¢ Age Proximity      â”‚  â”‚
    â”‚  â”‚ â€¢ Weighted Scoring   â”‚  â”‚
    â”‚  â”‚ â€¢ Threshold Logic    â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Query Existing Cases      â”‚
    â”‚  From Database             â”‚
    â”‚  (SQLite/models.py)        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Calculate Similarity      â”‚
    â”‚  For Each Match            â”‚
    â”‚  â€¢ Drug: 40%               â”‚
    â”‚  â€¢ Symptoms: 40%           â”‚
    â”‚  â€¢ Demographics: 15%       â”‚
    â”‚  â€¢ Time: 5%                â”‚
    â”‚  = TOTAL SCORE             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Filter by Threshold       â”‚
    â”‚  (Default: 0.75 = 75%)     â”‚
    â”‚                            â”‚
    â”‚  Return Matches Above â†‘    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Generate Recommendation   â”‚
    â”‚  â€¢ 0-59%: ACCEPT           â”‚
    â”‚  â€¢ 60-79%: REVIEW          â”‚
    â”‚  â€¢ 80-89%: REVIEW (High)   â”‚
    â”‚  â€¢ 90%+: DISCARD           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Response to Frontend      â”‚
    â”‚  {                         â”‚
    â”‚    matches: [...],         â”‚
    â”‚    recommendation: "...",  â”‚
    â”‚    action: "REVIEW"        â”‚
    â”‚  }                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  IF Matches Found:         â”‚
    â”‚  Show Case Match Modal     â”‚
    â”‚  ELSE: Continue Submit     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                         â”‚
          â–¼                         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ SHOW MODAL       â”‚   â”‚ NO MATCHES FOUND â”‚
    â”‚                  â”‚   â”‚                  â”‚
    â”‚ â€¢ Display Cases  â”‚   â”‚ Submit as New    â”‚
    â”‚ â€¢ Score Details  â”‚   â”‚ Case             â”‚
    â”‚ â€¢ Buttons:       â”‚   â”‚                  â”‚
    â”‚   - New Case     â”‚   â”‚ Response: {      â”‚
    â”‚   - Link         â”‚   â”‚   success: true, â”‚
    â”‚   - Discard      â”‚   â”‚   case_id: "..." â”‚
    â”‚                  â”‚   â”‚ }                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                 â”‚            â”‚
    â–¼                 â–¼            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NEW    â”‚    â”‚ LINK TO     â”‚  â”‚ DISCARD  â”‚
â”‚ CASE   â”‚    â”‚ EXISTING    â”‚  â”‚ DUPLICATEâ”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
    â”‚                â”‚              â”‚
    â–¼                â–¼              â–¼
POST        POST /api/cases/   POST /api/cases/
/api/cases/ link              discard
match(no                        
matches)    Update:            Update:
            â€¢ new_case.        â€¢ case.
            linked_case_id     status =
            â€¢ new_case.        'Discarded'
            match_score
            â€¢ case_status =
            'Linked'

    â”‚                â”‚              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Update Database     â”‚
    â”‚  (Patient Table)     â”‚
    â”‚                      â”‚
    â”‚  New Fields:         â”‚
    â”‚  â€¢ case_status       â”‚
    â”‚  â€¢ linked_case_id    â”‚
    â”‚  â€¢ match_score       â”‚
    â”‚  â€¢ match_notes       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Show Result to User â”‚
    â”‚  â€¢ Success Message   â”‚
    â”‚  â€¢ Case ID           â”‚
    â”‚  â€¢ Match Details     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FRONTEND                              â”‚
â”‚                (Doctor Report Page)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ Form Data
                     â”‚ (drugName, symptoms, age, gender)
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BACKEND (Flask)                       â”‚
â”‚                  (app.py)                                â”‚
â”‚                                                          â”‚
â”‚  POST /api/cases/match                                   â”‚
â”‚  â”œâ”€ Validate input                                       â”‚
â”‚  â”œâ”€ Call case_matching service                           â”‚
â”‚  â””â”€ Return results with recommendations                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 MATCHING ENGINE                          â”‚
â”‚        (pv_backend/services/case_matching.py)           â”‚
â”‚                                                          â”‚
â”‚  1. Query Database for cases with same drug             â”‚
â”‚  2. For each existing case:                             â”‚
â”‚     â”œâ”€ calc_text_similarity(symptoms)                   â”‚
â”‚     â”œâ”€ calc_age_similarity(ages)                        â”‚
â”‚     â”œâ”€ calc_demographics_match(gender)                  â”‚
â”‚     â”œâ”€ calc_time_recency(created_at)                    â”‚
â”‚     â””â”€ weighted_score = (SÃ—0.4 + AÃ—0.4 + DÃ—0.15 + TÃ—0.05)
â”‚  3. Filter matches > threshold                          â”‚
â”‚  4. Generate recommendation                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   DATABASE                              â”‚
â”‚                 (models.py)                              â”‚
â”‚                                                          â”‚
â”‚  Patient Table:                                          â”‚
â”‚  â”œâ”€ id (PK)                                             â”‚
â”‚  â”œâ”€ drug_name                                           â”‚
â”‚  â”œâ”€ symptoms                                            â”‚
â”‚  â”œâ”€ age                                                 â”‚
â”‚  â”œâ”€ gender                                              â”‚
â”‚  â”œâ”€ NEW: linked_case_id â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”œâ”€ NEW: match_score             â”‚                     â”‚
â”‚  â”œâ”€ NEW: case_status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€ Self-Reference    â”‚
â”‚  â””â”€ NEW: match_notes             â”‚                     â”‚
â”‚                                   â”‚                     â”‚
â”‚  Example Links:                   â”‚                     â”‚
â”‚  Case1 (PT-1001): linked=null    â”‚                     â”‚
â”‚  Case2 (DR-123): linked=PT-1001  â”‚                     â”‚
â”‚  Case3 (PH-456): linked=null     â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Decision Tree

```
                    New Case Submitted
                           â”‚
                           â–¼
                  Check for Matches
                           â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚                 â”‚
            NO MATCHES        MATCHES FOUND
                  â”‚                 â”‚
                  â–¼                 â–¼
            ACCEPT â”€â”€â”€â”€â”€â”€â”€â”€â–º  Show Modal
                  â”‚                 â”‚
                  â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚         â”‚                â”‚        â”‚
                  â”‚         â–¼                â–¼        â–¼
                  â”‚      User Reviews    Click Link  Click
                  â”‚      Similarity      or Discard  New Case
                  â”‚         â”‚                â”‚        â”‚
                  â”‚         â–¼                â–¼        â–¼
                  â”‚      High Match?    Confirmed?  Confirmed?
                  â”‚      (>80%)         Duplicate   New Case
                  â”‚         â”‚                â”‚        â”‚
                  â”‚      â”Œâ”€â”€â”´â”€â”€â”€â”            â”‚        â”‚
                  â”‚      â”‚      â”‚            â”‚        â”‚
                  â”‚    YES    NO             â”‚        â”‚
                  â”‚      â”‚      â”‚            â”‚        â”‚
                  â”‚      â–¼      â–¼            â–¼        â–¼
                  â”‚   DISCARD ACCEPT    DISCARD   ACCEPT
                  â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                    â”‚
                â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
                â”‚ UPDATE â”‚          â”‚ INSERT  â”‚
                â”‚ EXISTINGâ”‚          â”‚ NEW     â”‚
                â”‚ CASE    â”‚          â”‚ CASE    â”‚
                â”‚         â”‚          â”‚         â”‚
                â”‚status = â”‚          â”‚status = â”‚
                â”‚Linked   â”‚          â”‚Active   â”‚
                â”‚         â”‚          â”‚         â”‚
                â”‚match_   â”‚          â”‚linked_  â”‚
                â”‚score    â”‚          â”‚case_id  â”‚
                â”‚match_   â”‚          â”‚= null   â”‚
                â”‚notes    â”‚          â”‚         â”‚
                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                     â”‚                    â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                         SAVE DATABASE
                               â”‚
                               â–¼
                      SHOW SUCCESS MESSAGE
```

---

## Request/Response Flow

### Request 1: Check for Matches
```
â”Œâ”€ REQUEST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /api/cases/match                              â”‚
â”‚ Content-Type: application/json                     â”‚
â”‚                                                     â”‚
â”‚ {                                                   â”‚
â”‚   "drugName": "Aspirin",                           â”‚
â”‚   "symptoms": "headache, fever",                   â”‚
â”‚   "age": 45,                                       â”‚
â”‚   "gender": "Female",                              â”‚
â”‚   "threshold": 0.75                                â”‚
â”‚ }                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€ RESPONSE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ {                                                   â”‚
â”‚   "success": true,                                 â”‚
â”‚   "matches": [                                     â”‚
â”‚     {                                              â”‚
â”‚       "case_id": "PT-1001",                        â”‚
â”‚       "similarity_score": 0.82,                    â”‚
â”‚       "breakdown": {                               â”‚
â”‚         "drug": 1.0,                               â”‚
â”‚         "symptoms": 0.75,                          â”‚
â”‚         "demographics": 0.6,                       â”‚
â”‚         "time_recency": 0.9                        â”‚
â”‚       },                                           â”‚
â”‚       "confidence": "High",                        â”‚
â”‚       "...": "...other fields..."                  â”‚
â”‚     }                                              â”‚
â”‚   ],                                               â”‚
â”‚   "total_matches": 1,                              â”‚
â”‚   "recommendation": "REVIEW",                      â”‚
â”‚   "action": "REVIEW",                              â”‚
â”‚   "reason": "High similarity with PT-1001"         â”‚
â”‚ }                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Request 2: Link Cases
```
â”Œâ”€ REQUEST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /api/cases/link                               â”‚
â”‚                                                     â”‚
â”‚ {                                                   â”‚
â”‚   "newCaseId": "DR-1234567890",                    â”‚
â”‚   "linkedCaseId": "PT-1001",                       â”‚
â”‚   "matchScore": 0.82,                              â”‚
â”‚   "notes": "Doctor confirmed duplicate"            â”‚
â”‚ }                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€ RESPONSE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ {                                                   â”‚
â”‚   "success": true,                                 â”‚
â”‚   "message": "Case linked successfully",           â”‚
â”‚   "case": {                                        â”‚
â”‚     "id": "DR-1234567890",                         â”‚
â”‚     "status": "Linked",                            â”‚
â”‚     "linkedCaseId": "PT-1001",                     â”‚
â”‚     "matchScore": 0.82                             â”‚
â”‚   }                                                â”‚
â”‚ }                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Modal UI Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   CASE MATCH MODAL                     â”‚
â”‚                                                        â”‚
â”‚ âš ï¸  Potential Duplicate Cases Found  [X Close]        â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                        â”‚
â”‚ This case appears similar to existing cases:          â”‚
â”‚                                                        â”‚
â”‚ â”Œâ”€ MATCH #1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ â˜ Case ID: PT-1001                              â”‚  â”‚
â”‚ â”‚   Patient: John Doe                              â”‚  â”‚
â”‚ â”‚   Drug: Aspirin                                  â”‚  â”‚
â”‚ â”‚   Symptoms: headache                             â”‚  â”‚
â”‚ â”‚   Age: 47, Gender: Male                          â”‚  â”‚
â”‚ â”‚   Reported: Jan 25, 2026                         â”‚  â”‚
â”‚ â”‚                                                  â”‚  â”‚
â”‚ â”‚ Match Score: ğŸ”´ 82% (High)                       â”‚  â”‚
â”‚ â”‚                                                  â”‚  â”‚
â”‚ â”‚ Score Breakdown:                                 â”‚  â”‚
â”‚ â”‚   Drug Match............ 100%                    â”‚  â”‚
â”‚ â”‚   Symptom Match......... 78%                     â”‚  â”‚
â”‚ â”‚   Demographics.......... 60%                     â”‚  â”‚
â”‚ â”‚   Time Recency.......... 90%                     â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                        â”‚
â”‚ ğŸ“Œ Recommendation:                                     â”‚
â”‚    REVIEW - Likely duplicate, review before accepting â”‚
â”‚                                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ [Cancel] [Link to Selected Case] [Discard]      â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Color Coding

```
SIMILARITY SCORES:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 0-59%    âšª Green   - ACCEPT (Low match)  â”‚
â”‚ 60-79%   ğŸŸ¡ Orange - REVIEW (Medium)     â”‚
â”‚ 80-89%   ğŸ”´ Red    - REVIEW (High)       â”‚
â”‚ 90-100%  â›” Dark Red - DISCARD (Very High)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Component Relationships

```
doctor/report.html
â”œâ”€ HTML Form
â”‚  â”œâ”€ Drug Name Input
â”‚  â”œâ”€ Symptoms Textarea
â”‚  â”œâ”€ Age Input
â”‚  â”œâ”€ Gender Select
â”‚  â””â”€ Submit Button
â”‚
â”œâ”€ Case Match Modal (Hidden by default)
â”‚  â”œâ”€ Header
â”‚  â”œâ”€ Matches List (Dynamically populated)
â”‚  â”œâ”€ Recommendation Box
â”‚  â””â”€ Action Buttons
â”‚
â””â”€ JavaScript Functions
   â”œâ”€ submitExperience()
   â”‚  â”œâ”€ Collect form data
   â”‚  â””â”€ Call /api/cases/match
   â”‚
   â”œâ”€ showCaseMatchModal()
   â”‚  â”œâ”€ Display modal
   â”‚  â””â”€ Populate matches
   â”‚
   â”œâ”€ selectMatchCase()
   â”‚  â””â”€ Handle case selection
   â”‚
   â”œâ”€ linkToExistingCase()
   â”‚  â””â”€ Call /api/cases/link
   â”‚
   â”œâ”€ discardDuplicateCase()
   â”‚  â””â”€ Call /api/cases/discard
   â”‚
   â””â”€ proceedWithNewCase()
      â””â”€ Submit as new case

app.py
â”œâ”€ POST /api/cases/match
â”‚  â””â”€ Call match_new_case()
â”‚
â”œâ”€ POST /api/cases/link
â”‚  â””â”€ Update database
â”‚
â”œâ”€ POST /api/cases/discard
â”‚  â””â”€ Update database
â”‚
â””â”€ GET /api/cases/{id}/details
   â””â”€ Return case info

case_matching.py
â”œâ”€ CaseMatchingEngine Class
â”‚  â”œâ”€ calculate_text_similarity()
â”‚  â”œâ”€ calculate_age_similarity()
â”‚  â”œâ”€ calculate_case_similarity()
â”‚  â””â”€ find_matching_cases()
â”‚
â””â”€ Utility Functions
   â”œâ”€ match_new_case()
   â””â”€ should_accept_case()

models.py
â””â”€ Patient Model
   â”œâ”€ ...existing fields...
   â”œâ”€ linked_case_id (NEW)
   â”œâ”€ match_score (NEW)
   â”œâ”€ case_status (NEW)
   â””â”€ match_notes (NEW)
```

---

## Summary

This architecture provides:

âœ… **Separation of Concerns** - Each layer has specific responsibility  
âœ… **Scalability** - Can handle large databases  
âœ… **User Control** - Manual approval of matches  
âœ… **Audit Trail** - All changes logged  
âœ… **Easy Maintenance** - Modular, well-documented code  
