<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>My Patients - MedSafe</title><link rel="stylesheet" href="/static/css/style.css"><script src="https://unpkg.com/lucide@latest"></script><script type="module" src="/static/js/sidebar.js"></script><style>.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-overlay.active {
    display: flex;
}

.modal {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
}

.split-view {
    display: grid;
    grid-template-columns: 350px 1fr;
    gap: 1.5rem;
    height: calc(100vh - 4rem - 60px);
}

.patient-list-panel {
    background: white;
    border: 1px solid #E2E8F0;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    border-radius: 12px;
}

.patient-list {
    overflow-y: auto;
    flex: 1;
}

.patient-item {
    padding: 1rem;
    border-bottom: 1px solid #F1F5F9;
    cursor: pointer;
}

.patient-item:hover,
.patient-item.active {
    background-color: var(--secondary);
}

.patient-detail-panel {
    background: white;
    border: 1px solid #E2E8F0;
    padding: 2rem;
    overflow-y: auto;
    border-radius: 12px;
}

</style></head><body><div class="dashboard-layout"><app-sidebar></app-sidebar><main class="main-content"><header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;"><h1>My Patients</h1><button class="btn btn-primary" onclick="openAddModal()">+Add Patient</button></header><div class="split-view"><div class="patient-list-panel"><div style="padding:1rem; border-bottom:1px solid #eee;"><input type="text" id="patient-search" placeholder="Search..." onkeyup="renderList()"></div><div class="patient-list" id="list-container"><p style="padding:1rem; text-align:center;">Loading...</p></div></div><div class="patient-detail-panel" id="detail-panel"><p style="text-align:center; margin-top:4rem; color:#888;">Select a patient</p></div></div></main></div><!-- ADD PATIENT MODAL --><div class="modal-overlay" id="add-modal"><div class="modal"><div style="display:flex; justify-content:space-between; margin-bottom:1rem;"><h3>Add Patient</h3><button onclick="closeAddModal()" style="border:none; cursor:pointer; background:none; font-size:1.2rem;">X</button></div><form onsubmit="savePatient(event)"><div style="margin-bottom:1rem"><label>Name</label><input type="text" name="name" required style="width:100%; padding:0.5rem; border:1px solid #ccc; border-radius:4px;"></div><div style="margin-bottom:1rem"><label>Age</label><input type="number" name="age" required style="width:100%; padding:0.5rem; border:1px solid #ccc; border-radius:4px;"></div><div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-bottom:1rem;"><div><label>Gender</label><select name="gender" style="width:100%; padding:0.5rem;"><option value="Male">Male</option><option value="Female">Female</option></select></div><div><label>Phone</label><input type="tel" name="phone" style="width:100%; padding:0.5rem; border:1px solid #ccc; border-radius:4px;"></div></div><div style="margin-bottom:1rem"><label>Drug</label><input type="text" name="drugName" required style="width:100%; padding:0.5rem; border:1px solid #ccc; border-radius:4px;"></div><div style="margin-bottom:1rem"><label>Symptoms</label><textarea name="symptoms" style="width:100%; padding:0.5rem; border:1px solid #ccc; border-radius:4px;"></textarea></div><button type="submit" class="btn btn-primary" style="width:100%">Save Patient</button></form></div></div><!-- REPORT SYMPTOM MODAL --><div class="modal-overlay" id="symptom-modal"><div class="modal"><div style="display:flex; justify-content:space-between; margin-bottom:1rem;"><h3>Report Side Effect</h3><button onclick="closeSymptomModal()" style="border:none; cursor:pointer; background:none; font-size:1.2rem;">X</button></div><p id="symptom-patient-name" style="color:#666; margin-bottom:1rem;"></p><form onsubmit="submitSymptom(event)"><div style="margin-bottom:1rem"><label>New Symptom / Side Effect</label><textarea name="newSymptom" required rows="4" style="width:100%; padding:0.5rem; border:1px solid #ccc; border-radius:4px;" placeholder="Describe what happened..."></textarea></div><button type="submit" class="btn btn-warning" style="width:100%">Submit Report</button></form></div></div><script>let patients=[];
let selectedId=null;
let reportingId=null;

// --- ADD MODAL ---
function openAddModal() {
    document.getElementById('add-modal').classList.add('active');
}

function closeAddModal() {
    document.getElementById('add-modal').classList.remove('active');
}

// --- SYMPTOM MODAL ---
function openSymptomModal(id) {
    reportingId=id;
    const p=patients.find(x=> x.id===id);
    document.getElementById('symptom-patient-name').innerText='Reporting for: '+(p ? p.name : id);
    document.getElementById('symptom-modal').classList.add('active');
}

function closeSymptomModal() {
    document.getElementById('symptom-modal').classList.remove('active');
    reportingId=null;
}

async function init() {
    try {
        const res=await fetch('/api/patients');
        if( !res.ok) throw new Error("API Failed");
        patients=await res.json();
        renderList();
        lucide.createIcons();
    }

    catch(e) {
        console.error(e);
        document.getElementById('list-container').innerHTML='<p style="color:red; text-align:center">Error loading data</p>';
    }}

function renderList() {
    const filter=document.getElementById('patient-search').value.toLowerCase();
    const container=document.getElementById('list-container');
    const filtered=patients.filter(p=> (p.name||'').toLowerCase().includes(filter));

    if(filtered.length===0) {
        container.innerHTML='<p style="padding:1rem; text-align:center">No matches.</p>';
        return;
    }

    container.innerHTML=filtered.map(p=> {
            return '<div class="patient-item" onclick="selectPatient(\'' + p.id + '\')">' + '<strong>' + p.name + '</strong> <span style="font-size:0.8rem; color:grey">' + p.id + '</span>' + '</div>';
        }).join('');
}

function selectPatient(id) {
    const p=patients.find(x=> x.id===id);
    const panel=document.getElementById('detail-panel');
    // Using concatenation for safety
    panel.innerHTML='<h2>'+p.name+'</h2>'+'<p>ID: '+p.id+' | Age: '+p.age+'</p>'+'<hr>'+'<p><strong>Drug:</strong> '+p.drugName+'</p>'+'<p><strong>Symptoms:</strong> <pre style="font-family:inherit; white-space:pre-wrap; background:#f5f5f5; padding:0.5rem; border-radius:4px;">'+(p.symptoms || 'None')+'</pre></p>'+'<p><strong>Risk:</strong> '+p.riskLevel+'</p>'+'<div style="margin-top:2rem;">'+'<button class="btn btn-outline" onclick="openSymptomModal(\''+p.id+'\')">Report New Side Effect</button>'+'</div>';
}

async function savePatient(e) {
    e.preventDefault();
    const formData=new FormData(e.target);
    const data=Object.fromEntries(formData.entries());
    data.age=parseInt(data.age);

    try {
        const res=await fetch('/api/patients', {

            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }

            ,
            body: JSON.stringify(data)
        });
    const result=await res.json();

    if(result.success) {
        patients.push(result.patient);
        renderList();
        closeAddModal();
        e.target.reset();
        selectPatient(result.patient.id);
    }

    else {
        alert('Error: ' + result.message);
    }}

catch(err) {
    console.error(err);
    alert('Network Error');
}}

async function submitSymptom(e) {
    e.preventDefault();
    if( !reportingId) return;
    const textarea=e.target.querySelector('textarea');
    const symptom=textarea.value;

    try {
        const res=await fetch('/api/patients/' + reportingId + '/symptoms', {

            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }

            ,
            body: JSON.stringify({
                symptom: symptom
            })
    });
const result=await res.json();

if(result.success) {
    // Update local
    const idx=patients.findIndex(p=> p.id===reportingId);
    if(idx !==-1) patients[idx]=result.patient;

    renderList();
    selectPatient(reportingId); // Update detail view
    closeSymptomModal();
    e.target.reset();
    alert("Report Submitted Successfully");
}

else {
    alert("Error: " + result.message);
}}

catch(err) {
    console.error(err);
    alert("Network error reporting side effect.");
}}

window.onload=init;
</script></body></html>