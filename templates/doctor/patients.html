<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>My Patients - MedSafe</title><link rel="stylesheet" href="/static/css/style.css"><script src="https://unpkg.com/lucide@latest"></script><script type="module" src="/static/js/sidebar.js"></script><style>

/* Embedded critical styles to ensure modal works even if CSS fails */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
    z-index: 1000;
}

.modal-overlay.active {
    opacity: 1;
    pointer-events: all;
}

.modal {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
}

.split-view {
    display: grid;
    grid-template-columns: 350px 1fr;
    gap: 1.5rem;
    height: calc(100vh - 4rem - 60px);
}

.patient-list-panel {
    background: white;
    border-radius: 12px;
    border: 1px solid #E2E8F0;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.search-area {
    padding: 1rem;
    border-bottom: 1px solid #E2E8F0;
}

.patient-list {
    flex: 1;
    overflow-y: auto;
}

.patient-item {
    padding: 1rem;
    border-bottom: 1px solid #F1F5F9;
    cursor: pointer;
    transition: background 0.2s;
}

.patient-item:hover,
.patient-item.active {
    background-color: var(--secondary);
}

.patient-detail-panel {
    background: white;
    border-radius: 12px;
    border: 1px solid #E2E8F0;
    padding: 2rem;
    overflow-y: auto;
}

.detail-section {
    padding-bottom: 1.5rem;
    margin-bottom: 1.5rem;
    border-bottom: 1px solid #F1F5F9;
}

</style></head><body><div class="dashboard-layout"><app-sidebar></app-sidebar><main class="main-content"><header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;"><h1>My Patients</h1><!-- DIRECT ONCLICK --><button class="btn btn-primary" onclick="window.openModal()">+Add Patient</button></header><div class="split-view"><div class="patient-list-panel"><div class="search-area"><input type="text" id="patient-search" placeholder="Search by Name or ID..." onkeyup="window.filterList(this.value)"></div><div class="patient-list" id="patient-list-container"><p style="padding: 1rem; text-align: center;">Loading patients...</p></div></div><div class="patient-detail-panel" id="detail-panel"><div style="text-align: center; color: var(--text-muted); padding-top: 4rem;"><i data-lucide="user-search" style="width: 48px; height: 48px; margin-bottom: 1rem;"></i><p>Select a patient to view details</p></div></div></div></main></div><!-- ADD PATIENT MODAL --><div class="modal-overlay" id="add-modal"><div class="modal"><div class="modal-header" style="display: flex; justify-content: space-between; margin-bottom: 1.5rem;"><h3 style="margin: 0;">Add New Patient</h3><button onclick="window.closeModal()" style="background:none; border:none; cursor:pointer;"><i data-lucide="x"></i></button></div><form id="add-patient-form" onsubmit="window.handleFormSubmit(event)"><div class="form-group" style="margin-bottom: 1rem;"><label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Full Name</label><input type="text" name="name" required placeholder="e.g. Jane Doe" style="width: 100%; padding: 0.75rem; border: 1px solid #E2E8F0; border-radius: 6px;"></div><div class="form-group" style="margin-bottom: 1rem;"><label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Phone Number</label><input type="tel" name="phone" placeholder="e.g. 555-0123" style="width: 100%; padding: 0.75rem; border: 1px solid #E2E8F0; border-radius: 6px;"></div><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;"><div class="form-group"><label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Age</label><input type="number" name="age" required min="0" max="120" style="width: 100%; padding: 0.75rem; border: 1px solid #E2E8F0; border-radius: 6px;"></div><div class="form-group"><label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Gender</label><select name="gender" style="width: 100%; padding: 0.75rem; border: 1px solid #E2E8F0; border-radius: 6px;"><option value="Male">Male</option><option value="Female">Female</option><option value="Other">Other</option></select></div></div><div class="form-group" style="margin-bottom: 1rem;"><label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Current Medication</label><input type="text" name="drugName" required placeholder="e.g. Lisinopril" style="width: 100%; padding: 0.75rem; border: 1px solid #E2E8F0; border-radius: 6px;"></div><div class="form-group" style="margin-bottom: 1.5rem;"><label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Reported Symptoms</label><textarea name="symptoms" placeholder="e.g. Dizziness" style="width: 100%; padding: 0.75rem; border: 1px solid #E2E8F0; border-radius: 6px;" rows="3"></textarea></div><div style="display: flex; justify-content: flex-end; gap: 1rem;"><button type="button" class="btn btn-outline" onclick="window.closeModal()">Cancel</button><button type="submit" class="btn btn-primary">Save Patient</button></div></form></div></div><!-- Inline Logic for Reliability --><script> // Global State
window.patients=[];
window.selectedId=new URLSearchParams(window.location.search).get('id');

// Modal Controls
window.openModal=function() {
    document.getElementById('add-modal').classList.add('active');
}

window.closeModal=function() {
    document.getElementById('add-modal').classList.remove('active');
}

// --- Data Fetching ---
window.init=async function() {
    try {
        const res=await fetch('/api/patients');
        if ( !res.ok) throw new Error('API Error');
        window.patients=await res.json();
        window.renderList();
        if (window.selectedId) window.renderDetail(window.selectedId);
        lucide.createIcons();
    }

    catch (err) {
        console.error(err);
        document.getElementById('patient-list-container').innerHTML='<p style="padding:1rem; color:red; text-align:center;">Failed to load data.</p>';
    }}

// --- Rendering ---
window.renderList=function(filter='') {
    const container=document.getElementById('patient-list-container');
    const filtered=window.patients.filter(p=> (p.name || '').toLowerCase().includes(filter.toLowerCase()) || (p.id || '').toLowerCase().includes(filter.toLowerCase()));

    if (filtered.length===0) {
        container.innerHTML='<p style="padding: 1rem; text-align: center;">No patients found.</p>';
        return;
    }

    container.innerHTML=filtered.map(p=> ` <div class="patient-item ${p.id === window.selectedId ? 'active' : ''}"

        onclick="window.selectPatient('${p.id}')" > <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;" > <strong style="color: var(--primary-dark);" >${
            p.name || 'Unknown'
        }

        </strong> <span class="badge badge-${(p.riskLevel||'low').toLowerCase()}" >${
            p.riskLevel||'Low'
        }

        Risk</span> </div> <div style="font-size: 0.85rem; color: var(--text-muted);" > ID: ${
            p.id
        }

        • ${
            p.age
        }

        yrs • ${
            p.gender
        }

        </div> </div> `).join('');
}

window.selectPatient=function(id) {
    window.selectedId=id;

    window.history.pushState({}

    , '', '?id=' +id);
window.renderList(document.getElementById('patient-search').value);
window.renderDetail(id);
}

window.renderDetail=function(id) {
    const p=window.patients.find(x=> x.id===id);
    if ( !p) return;

    const panel=document.getElementById('detail-panel');

    panel.innerHTML=` <div class="detail-section"><div style="display: flex; justify-content: space-between; align-items: start;"><div><h2 style="margin-bottom: 0.5rem;">${
        p.name
    }

    </h2><p style="color: var(--text-muted);">ID: ${
        p.id
    }

    • ${
        p.age
    }

    yrs • ${
        p.gender
    }

    <br>${
        p.phone ? `Phone: ${
            p.phone
        }

        ` : ''
    }

    </p></div><div style="text-align: right;"><span class="badge badge-${(p.riskLevel||'low').toLowerCase()}">${
        p.riskLevel||'Low'
    }

    Risk</span></div></div></div><div class="detail-section"><h4>Medication</h4><p><strong>${
        p.drugName
    }

    </strong></p></div><div class="detail-section"><h4>Timeline</h4><p>Reported: ${
        new Date(p.created_at || Date.now()).toLocaleDateString()
    }

    </p><p>${
        p.symptoms || 'No symptoms.'
    }

    </p></div>`;
    // Re-run icons if needed, though simpler now
}

window.filterList=function(val) {
    window.renderList(val);
}

// --- Form Handling ---
window.handleFormSubmit=async function(e) {
    e.preventDefault();
    const btn=e.target.querySelector('button[type="submit"]');
    btn.textContent='Saving...';
    btn.disabled=true;

    const formData=new FormData(e.target);
    const data=Object.fromEntries(formData.entries());

    try {
        const res=await fetch('/api/patients', {

            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }

            ,
            body: JSON.stringify(data)
        });
    const result=await res.json();

    if (result.success) {
        window.patients.push(result.patient); // Add to local
        window.selectPatient(result.patient.id);
        window.closeModal();
        e.target.reset();
    }

    else {
        alert("Error: " + result.message);
    }}

catch (err) {
    console.error(err);
    alert("Network Error");
}

finally {
    btn.textContent='Save Patient';
    btn.disabled=false;
}}

// Start
window.init();
</script></body></html>