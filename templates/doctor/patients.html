<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>My Patients - MedSafe</title><link rel="stylesheet" href="/static/css/style.css"><script src="https://unpkg.com/lucide@latest"></script><script type="module" src="/static/js/sidebar.js"></script><style>

/* Embedded critical styles to ensure modal works even if CSS fails */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
    z-index: 1000;
}

.modal-overlay.active {
    opacity: 1;
    pointer-events: all;
}

.modal {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
}

.split-view {
    display: grid;
    grid-template-columns: 350px 1fr;
    gap: 1.5rem;
    height: calc(100vh - 4rem - 60px);
}

.patient-list-panel {
    background: white;
    border-radius: 12px;
    border: 1px solid #E2E8F0;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.search-area {
    padding: 1rem;
    border-bottom: 1px solid #E2E8F0;
}

.search-area input {
    width: 100%;
    max-width: 500px;
    box-sizing: border-box;
}

.patient-list {
    flex: 1;
    overflow-y: auto;
}

.patient-item {
    padding: 1rem;
    border-bottom: 1px solid #F1F5F9;
    cursor: pointer;
    transition: background 0.2s;
}

.patient-item:hover,
.patient-item.active {
    background-color: var(--secondary);
}

.patient-detail-panel {
    background: white;
    border-radius: 12px;
    border: 1px solid #E2E8F0;
    padding: 2rem;
    overflow-y: auto;
}

.detail-section {
    padding-bottom: 1.5rem;
    margin-bottom: 1.5rem;
    border-bottom: 1px solid #F1F5F9;
}

</style></head><body><div class="dashboard-layout"><app-sidebar></app-sidebar><main class="main-content"><header style="display: flex; justify-content: center; align-items: center; margin-bottom: 1.5rem; flex-direction: column; gap: 1rem;"><h1 style="text-align: center; margin: 0;">My Patients</h1><div style="display: flex; gap: 1rem; align-items: center;"><div style="display: flex; gap: 0.5rem; background: #F9FAFB; padding: 0.25rem; border-radius: 8px; border: 1px solid #E2E8F0;"><button class="mode-btn active" onclick="window.switchMode('identity')" style="padding: 0.5rem 1rem; border: none; background: white; border-radius: 6px; cursor: pointer; font-weight: 600; color: var(--primary-dark); transition: all 0.2s;">Data with Identity</button><button class="mode-btn" onclick="window.switchMode('anonymized')" style="padding: 0.5rem 1rem; border: none; background: transparent; border-radius: 6px; cursor: pointer; font-weight: 600; color: var(--text-muted); transition: all 0.2s;">Anonymized Data</button></div><button class="btn btn-primary" onclick="window.openModal()">+Add Patient</button></div></header><div class="split-view"><div class="patient-list-panel"><div class="search-area"><input type="text" id="patient-search" placeholder="Search by Name or ID..." onkeyup="window.filterList(this.value)" style="width: 100%; padding: 0.75rem; border: 1px solid #E2E8F0; border-radius: 6px; font-size: 1rem;"></div><div class="patient-list" id="patient-list-container"><p style="padding: 1rem; text-align: center;">Loading patients...</p></div></div><div class="patient-detail-panel" id="detail-panel"><div style="text-align: center; color: var(--text-muted); padding-top: 4rem;"><i data-lucide="user-search" style="width: 48px; height: 48px; margin-bottom: 1rem;"></i><p>Select a patient to view details</p></div></div></div></main></div><!-- ADD PATIENT MODAL --><div class="modal-overlay" id="add-modal"><div class="modal"><div class="modal-header" style="display: flex; justify-content: space-between; margin-bottom: 1.5rem;"><h3 style="margin: 0;" id="modal-title">Add New Patient</h3><button onclick="window.closeModal()" style="background:none; border:none; cursor:pointer;"><i data-lucide="x"></i></button></div><div style="margin-bottom: 1.5rem; display: flex; gap: 0.5rem; border-bottom: 1px solid #E2E8F0; padding-bottom: 1rem;"><button class="modal-tab-btn active" onclick="window.switchModalTab('form')" style="padding: 0.5rem 1rem; border: none; background: transparent; cursor: pointer; font-weight: 600; color: var(--primary-dark); border-bottom: 2px solid var(--primary); transition: all 0.2s;">Manual Entry</button><button class="modal-tab-btn" onclick="window.switchModalTab('excel')" style="padding: 0.5rem 1rem; border: none; background: transparent; cursor: pointer; font-weight: 600; color: var(--text-muted); border-bottom: 2px solid transparent; transition: all 0.2s;">Excel Upload</button></div><div id="form-tab" style="display: block;"><form id="add-patient-form" onsubmit="window.handleFormSubmit(event)"><div id="form-fields"></div><div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem;"><button type="button" class="btn btn-outline" onclick="window.closeModal()">Cancel</button><button type="submit" class="btn btn-primary">Save Patient</button></div></form></div><div id="excel-tab" style="display: none;"><div style="padding: 1rem; background: #F9FAFB; border-radius: 8px; margin-bottom: 1rem;"><p style="margin: 0 0 0.5rem 0; font-weight: 600;">Upload Excel File</p><p style="margin: 0; font-size: 0.9rem; color: var(--text-muted);">Supported format: .xlsx, .xls</p></div><input type="file" id="excel-file" accept=".xlsx,.xls" style="width: 100%; padding: 0.75rem; border: 2px dashed #E2E8F0; border-radius: 8px; margin-bottom: 1rem; cursor: pointer;"><div style="display: flex; justify-content: space-between; gap: 1rem;"><button type="button" class="btn btn-outline" onclick="window.downloadTemplate()">Download Template</button><button type="button" class="btn btn-primary" onclick="window.handleExcelUpload()">Upload</button></div></div></div></div><!-- Inline Logic for Reliability --><script>
// Global State
window.patients = [];
window.anonymizedPatients = [];
window.selectedId = new URLSearchParams(window.location.search).get('id');
window.currentMode = 'identity'; // 'identity' or 'anonymized'
window.currentModalTab = 'form'; // 'form' or 'excel'

// Mode Switching
window.switchMode = function(mode) {
    window.currentMode = mode;
    
    // Get all mode buttons
    const buttons = document.querySelectorAll('.mode-btn');
    
    // Deselect all buttons
    buttons.forEach(btn => {
        btn.classList.remove('active');
        btn.style.background = 'transparent';
        btn.style.color = 'var(--text-muted)';
    });
    
    // Select the correct button based on mode
    if (mode === 'identity') {
        buttons[0].classList.add('active');
        buttons[0].style.background = 'white';
        buttons[0].style.color = 'var(--primary-dark)';
    } else {
        buttons[1].classList.add('active');
        buttons[1].style.background = 'white';
        buttons[1].style.color = 'var(--primary-dark)';
    }
    
    // Update search placeholder
    const searchInput = document.getElementById('patient-search');
    if (mode === 'identity') {
        searchInput.placeholder = 'Search by Name or ID...';
    } else {
        searchInput.placeholder = 'Search by Anonymized ID...';
    }
    
    // Reset search and render
    searchInput.value = '';
    window.selectedId = null;
    window.renderList();
    
    // Clear detail panel
    document.getElementById('detail-panel').innerHTML = '<div style="text-align: center; color: var(--text-muted); padding-top: 4rem;"><i data-lucide="user-search" style="width: 48px; height: 48px; margin-bottom: 1rem;"></i><p>Select a patient to view details</p></div>';
    lucide.createIcons();
};

// Modal Tab Switching
window.switchModalTab = function(tab) {
    window.currentModalTab = tab;
    
    // Update tab button styles
    document.querySelectorAll('.modal-tab-btn').forEach(btn => {
        btn.style.color = 'var(--text-muted)';
        btn.style.borderBottom = '2px solid transparent';
    });
    event.target.style.color = 'var(--primary-dark)';
    event.target.style.borderBottom = '2px solid var(--primary)';
    
    // Show/hide tabs
    document.getElementById('form-tab').style.display = tab === 'form' ? 'block' : 'none';
    document.getElementById('excel-tab').style.display = tab === 'excel' ? 'block' : 'none';
};

// Generate Form Fields Based on Mode
window.generateFormFields = function() {
    const container = document.getElementById('form-fields');
    
    if (window.currentMode === 'identity') {
        container.innerHTML = `
            <div class="form-group" style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Full Name <span style="color: #DC2626;">*</span></label>
                <input type="text" name="name" required placeholder="e.g. Jane Doe" style="width: 100%; padding: 0.75rem; border: 1px solid #E2E8F0; border-radius: 6px;">
            </div>
            <div class="form-group" style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Patient ID</label>
                <input type="text" name="patientId" placeholder="e.g. P-12345" style="width: 100%; padding: 0.75rem; border: 1px solid #E2E8F0; border-radius: 6px;">
            </div>
            <div class="form-group" style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Medium of Contact <span style="color: #DC2626;">*</span></label>
                <select name="contactMedium" required style="width: 100%; padding: 0.75rem; border: 1px solid #E2E8F0; border-radius: 6px;">
                    <option value="">Select contact method</option>
                    <option value="email">Email</option>
                    <option value="phone">Phone</option>
                    <option value="address">Address</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-group" style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Contact Details <span style="color: #DC2626;">*</span></label>
                <input type="text" name="contactDetails" required placeholder="e.g. email@example.com or phone number" style="width: 100%; padding: 0.75rem; border: 1px solid #E2E8F0; border-radius: 6px;">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div class="form-group">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Age</label>
                    <input type="number" name="age" min="0" max="120" placeholder="Age" style="width: 100%; padding: 0.75rem; border: 1px solid #E2E8F0; border-radius: 6px;">
                </div>
                <div class="form-group">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Gender</label>
                    <select name="gender" style="width: 100%; padding: 0.75rem; border: 1px solid #E2E8F0; border-radius: 6px;">
                        <option value="">Select gender</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
            </div>
            <div class="form-group" style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Current Medication</label>
                <input type="text" name="drugName" placeholder="e.g. Lisinopril" style="width: 100%; padding: 0.75rem; border: 1px solid #E2E8F0; border-radius: 6px;">
            </div>
            <div class="form-group" style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Risk Level</label>
                <select name="riskLevel" style="width: 100%; padding: 0.75rem; border: 1px solid #E2E8F0; border-radius: 6px;">
                    <option value="Low">Low</option>
                    <option value="Medium">Medium</option>
                    <option value="High">High</option>
                </select>
            </div>
            <div class="form-group" style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Reported Symptoms</label>
                <textarea name="symptoms" placeholder="e.g. Dizziness" style="width: 100%; padding: 0.75rem; border: 1px solid #E2E8F0; border-radius: 6px;" rows="3"></textarea>
            </div>
        `;
    } else {
        container.innerHTML = `
            <div class="form-group" style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Anonymized Patient ID <span style="color: #DC2626;">*</span></label>
                <input type="text" name="anonId" required placeholder="e.g. ANON-12345" style="width: 100%; padding: 0.75rem; border: 1px solid #E2E8F0; border-radius: 6px;">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div class="form-group">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Age Group <span style="color: #DC2626;">*</span></label>
                    <select name="ageGroup" required style="width: 100%; padding: 0.75rem; border: 1px solid #E2E8F0; border-radius: 6px;">
                        <option value="">Select age group</option>
                        <option value="18-30">18-30</option>
                        <option value="31-45">31-45</option>
                        <option value="46-60">46-60</option>
                        <option value="60+">60+</option>
                    </select>
                </div>
                <div class="form-group">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Gender</label>
                    <select name="gender" style="width: 100%; padding: 0.75rem; border: 1px solid #E2E8F0; border-radius: 6px;">
                        <option value="">Select gender</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
            </div>
            <div class="form-group" style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Risk Category</label>
                <select name="riskLevel" style="width: 100%; padding: 0.75rem; border: 1px solid #E2E8F0; border-radius: 6px;">
                    <option value="Low">Low</option>
                    <option value="Medium">Medium</option>
                    <option value="High">High</option>
                </select>
            </div>
            <div class="form-group" style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Observation Notes</label>
                <textarea name="notes" placeholder="e.g. Observed symptoms" style="width: 100%; padding: 0.75rem; border: 1px solid #E2E8F0; border-radius: 6px;" rows="3"></textarea>
            </div>
        `;
    }
};

// Modal Controls
window.openModal = function() {
    document.getElementById('add-modal').classList.add('active');
    window.generateFormFields();
    window.currentModalTab = 'form';
    document.getElementById('form-tab').style.display = 'block';
    document.getElementById('excel-tab').style.display = 'none';
    document.querySelectorAll('.modal-tab-btn').forEach((btn, idx) => {
        if (idx === 0) {
            btn.style.color = 'var(--primary-dark)';
            btn.style.borderBottom = '2px solid var(--primary)';
        } else {
            btn.style.color = 'var(--text-muted)';
            btn.style.borderBottom = '2px solid transparent';
        }
    });
};

window.closeModal = function() {
    document.getElementById('add-modal').classList.remove('active');
    document.getElementById('add-patient-form').reset();
    document.getElementById('excel-file').value = '';
};

// Data Fetching
window.init = async function() {
    try {
        const res = await fetch('/api/patients');
        if (!res.ok) throw new Error('API Error');
        const allData = await res.json();
        
        // Separate data by mode
        window.patients = allData.filter(p => p.mode !== 'anonymized');
        window.anonymizedPatients = allData.filter(p => p.mode === 'anonymized');
        
        window.renderList();
        if (window.selectedId) window.renderDetail(window.selectedId);
        lucide.createIcons();
    } catch (err) {
        console.error(err);
        document.getElementById('patient-list-container').innerHTML = '<p style="padding:1rem; color:red; text-align:center;">Failed to load data.</p>';
    }
};

// Rendering
window.renderList = function(filter = '') {
    const container = document.getElementById('patient-list-container');
    const dataSource = window.currentMode === 'identity' ? window.patients : window.anonymizedPatients;
    
    let filtered;
    if (window.currentMode === 'identity') {
        filtered = dataSource.filter(p => 
            (p.name || '').toLowerCase().includes(filter.toLowerCase()) || 
            (p.patientId || '').toLowerCase().includes(filter.toLowerCase())
        );
    } else {
        filtered = dataSource.filter(p => 
            (p.anonId || '').toLowerCase().includes(filter.toLowerCase())
        );
    }

    if (filtered.length === 0) {
        container.innerHTML = '<p style="padding: 1rem; text-align: center;">No patients found.</p>';
        return;
    }

    if (window.currentMode === 'identity') {
        container.innerHTML = filtered.map(p => `
            <div class="patient-item ${p.id === window.selectedId ? 'active' : ''}" onclick="window.selectPatient('${p.id}')">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                    <strong style="color: var(--primary-dark);">${p.name || 'Unknown'}</strong>
                    <span class="badge badge-${(p.riskLevel || 'low').toLowerCase()}">${p.riskLevel || 'Low'} Risk</span>
                </div>
                <div style="font-size: 0.85rem; color: var(--text-muted);">
                    ID: ${p.patientId} • ${p.age} yrs • ${p.gender}
                </div>
            </div>
        `).join('');
    } else {
        container.innerHTML = filtered.map(p => `
            <div class="patient-item ${p.id === window.selectedId ? 'active' : ''}" onclick="window.selectPatient('${p.id}')">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                    <strong style="color: var(--primary-dark);">${p.anonId || 'Unknown'}</strong>
                    <span class="badge badge-${(p.riskLevel || 'low').toLowerCase()}">${p.riskLevel || 'Low'}</span>
                </div>
                <div style="font-size: 0.85rem; color: var(--text-muted);">
                    Age: ${p.ageGroup} • ${p.gender}
                </div>
            </div>
        `).join('');
    }
};

window.selectPatient = function(id) {
    window.selectedId = id;
    window.history.pushState({}, '', '?id=' + id);
    window.renderList(document.getElementById('patient-search').value);
    window.renderDetail(id);
};

window.renderDetail = function(id) {
    const dataSource = window.currentMode === 'identity' ? window.patients : window.anonymizedPatients;
    const p = dataSource.find(x => x.id === id);
    if (!p) return;

    const panel = document.getElementById('detail-panel');
    
    // Fetch full patient details including case scoring
    fetch(`/api/patients/${id}`)
        .then(res => res.json())
        .then(data => {
            if (!data.success) {
                console.error('Failed to fetch patient details');
                return;
            }
            
            const patient = data.patient;
            const scoring = patient.case_scoring || {};
            
            // Determine score color
            let scoreColor = '#6B7280'; // gray for unknown
            let scoreText = 'Not Scored';
            if (scoring.case_score !== null && scoring.case_score !== undefined) {
                if (scoring.case_score <= -1) {
                    scoreColor = '#DC2626'; // red for adverse
                    scoreText = `Score: ${scoring.case_score}`;
                } else if (scoring.case_score >= 1) {
                    scoreColor = '#10B981'; // green for positive
                    scoreText = `Score: +${scoring.case_score}`;
                } else {
                    scoreColor = '#F59E0B'; // amber for unclear
                    scoreText = `Score: ${scoring.case_score}`;
                }
            }

            if (window.currentMode === 'identity') {
                panel.innerHTML = `
                    <div class="detail-section">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h2 style="margin-bottom: 0.5rem;">${p.name}</h2>
                                <p style="color: var(--text-muted);">
                                    ID: ${patient.id || p.patientId || p.id} • ${p.age} yrs • ${p.gender}
                                </p>
                            </div>
                            <div style="text-align: right;">
                                <span class="badge badge-${(p.riskLevel || 'low').toLowerCase()}">${p.riskLevel || 'Low'} Risk</span>
                            </div>
                        </div>
                        
                        <!-- Contact Information -->
                        ${(patient.phone || patient.email) ? `
                            <div style="margin-top: 1rem; padding: 0.75rem; background: #F0FDF4; border-radius: 6px; border-left: 3px solid #22C55E;">
                                <p style="font-size: 0.8rem; font-weight: 600; color: #166534; margin-bottom: 0.5rem;">
                                    <i data-lucide="contact" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle;"></i>
                                    Contact for Follow-up
                                </p>
                                ${patient.phone ? `<p style="font-size: 0.85rem; margin: 0.25rem 0;"><i data-lucide="phone" style="width: 12px; height: 12px; display: inline-block; vertical-align: middle; margin-right: 0.5rem;"></i>${patient.phone}</p>` : ''}
                                ${patient.email ? `<p style="font-size: 0.85rem; margin: 0.25rem 0;"><i data-lucide="mail" style="width: 12px; height: 12px; display: inline-block; vertical-align: middle; margin-right: 0.5rem;"></i>${patient.email}</p>` : ''}
                            </div>
                        ` : ''}
                    </div>
                    <div class="detail-section">
                        <h4>Medication</h4>
                        <p><strong>${p.drugName}</strong></p>
                    </div>
                    <div class="detail-section">
                        <h4>Timeline</h4>
                        <p>Reported: ${new Date(p.created_at || p.createdAt || Date.now()).toLocaleDateString()}</p>
                        <p>${p.symptoms || 'No symptoms.'}</p>
                    </div>
                    
                    <!-- Case Scoring Section -->
                    <div class="detail-section" style="background: linear-gradient(135deg, #F0F7FF 0%, #F9FAFB 100%); border-radius: 8px; padding: 1rem; margin-top: 1rem;">
                        <h4 style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                            <i data-lucide="bar-chart-2" style="width: 18px; height: 18px;"></i>
                            Case Scoring
                        </h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div style="background: white; padding: 0.75rem; border-radius: 6px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: ${scoreColor};">${scoreText}</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">${scoring.case_score_interpretation || 'Not evaluated'}</div>
                            </div>
                            <div style="background: white; padding: 0.75rem; border-radius: 6px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: ${scoring.strength_level === 'High' ? '#10B981' : scoring.strength_level === 'Medium' ? '#F59E0B' : '#6B7280'};">
                                    ${scoring.strength_level || 'N/A'}
                                </div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">Strength Level</div>
                            </div>
                        </div>
                        
                        <div style="background: white; padding: 0.75rem; border-radius: 6px; margin-bottom: 0.75rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                <span style="font-size: 0.85rem;">Completeness</span>
                                <span style="font-size: 0.85rem; font-weight: 600;">${scoring.completeness_score || 0}%</span>
                            </div>
                            <div style="height: 6px; background: #E5E7EB; border-radius: 3px; overflow: hidden;">
                                <div style="height: 100%; width: ${scoring.completeness_score || 0}%; background: #3B82F6; border-radius: 3px;"></div>
                            </div>
                        </div>
                        
                        <div style="background: white; padding: 0.75rem; border-radius: 6px; margin-bottom: 0.75rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                <span style="font-size: 0.85rem;">Timeline Clarity</span>
                                <span style="font-size: 0.85rem; font-weight: 600;">${scoring.temporal_clarity_score || 0}%</span>
                            </div>
                            <div style="height: 6px; background: #E5E7EB; border-radius: 3px; overflow: hidden;">
                                <div style="height: 100%; width: ${scoring.temporal_clarity_score || 0}%; background: #8B5CF6; border-radius: 3px;"></div>
                            </div>
                        </div>
                        
                        <div style="background: white; padding: 0.75rem; border-radius: 6px; margin-bottom: 0.75rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                <span style="font-size: 0.85rem;">Medical Confirmation</span>
                                <span style="font-size: 0.85rem; font-weight: 600;">${scoring.medical_confirmation_score || 0}%</span>
                            </div>
                            <div style="height: 6px; background: #E5E7EB; border-radius: 3px; overflow: hidden;">
                                <div style="height: 100%; width: ${scoring.medical_confirmation_score || 0}%; background: #10B981; border-radius: 3px;"></div>
                            </div>
                        </div>
                        
                        ${scoring.follow_up_required ? `
                            <div style="background: #FEF3C7; padding: 0.75rem; border-radius: 6px; display: flex; align-items: center; gap: 0.5rem; margin-top: 0.75rem;">
                                <i data-lucide="alert-triangle" style="width: 16px; height: 16px; color: #D97706;"></i>
                                <span style="font-size: 0.85rem; color: #92400E; font-weight: 500;">Follow-up Required</span>
                                ${patient.followup_pending ? `<span style="font-size: 0.7rem; color: #059669; margin-left: auto;">✉️ Email Sent</span>` : ''}
                            </div>
                        ` : ''}
                        
                        ${scoring.evaluated_at ? `
                            <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.75rem; text-align: right;">
                                Evaluated: ${new Date(scoring.evaluated_at).toLocaleDateString()}
                            </p>
                        ` : ''}
                    </div>
                `;
            } else {
                panel.innerHTML = `
                    <div class="detail-section">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h2 style="margin-bottom: 0.5rem;">${p.anonId}</h2>
                                <p style="color: var(--text-muted);">
                                    Age Group: ${p.ageGroup} • ${p.gender}
                                </p>
                            </div>
                            <div style="text-align: right;">
                                <span class="badge badge-${(p.riskLevel || 'low').toLowerCase()}">${p.riskLevel || 'Low'}</span>
                            </div>
                        </div>
                    </div>
                    <div class="detail-section">
                        <h4>Observation Notes</h4>
                        <p>${p.notes || 'No notes.'}</p>
                    </div>
                    <div class="detail-section">
                        <h4>Added</h4>
                        <p>${new Date(p.created_at || Date.now()).toLocaleDateString()}</p>
                    </div>
                `;
            }
            
            lucide.createIcons();
        })
        .catch(err => {
            console.error('Error fetching patient details:', err);
            // Fallback to basic display
            if (window.currentMode === 'identity') {
                panel.innerHTML = `
                    <div class="detail-section">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h2 style="margin-bottom: 0.5rem;">${p.name}</h2>
                                <p style="color: var(--text-muted);">
                                    ID: ${p.patientId} • ${p.age} yrs • ${p.gender}
                                    ${p.phone ? `<br>Phone: ${p.phone}` : ''}
                                </p>
                            </div>
                            <div style="text-align: right;">
                                <span class="badge badge-${(p.riskLevel || 'low').toLowerCase()}">${p.riskLevel || 'Low'} Risk</span>
                            </div>
                        </div>
                    </div>
                    <div class="detail-section">
                        <h4>Medication</h4>
                        <p><strong>${p.drugName}</strong></p>
                    </div>
                    <div class="detail-section">
                        <h4>Timeline</h4>
                        <p>Reported: ${new Date(p.created_at || Date.now()).toLocaleDateString()}</p>
                        <p>${p.symptoms || 'No symptoms.'}</p>
                    </div>
                `;
            }
            lucide.createIcons();
        });
};

window.filterList = function(val) {
    window.renderList(val);
};

// Form Handling
window.handleFormSubmit = async function(e) {
    e.preventDefault();
    
    // Validate required fields
    const form = e.target;
    const inputs = form.querySelectorAll('input[required], select[required], textarea[required]');
    let hasEmptyFields = false;
    
    inputs.forEach(input => {
        if (!input.value.trim()) {
            hasEmptyFields = true;
        }
    });
    
    if (hasEmptyFields) {
        // Show centered error dialog
        const overlay = document.createElement('div');
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        `;
        overlay.innerHTML = `
            <div style="background: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 350px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); text-align: center;">
                <div style="width: 60px; height: 60px; background: #FEE2E2; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                    <i data-lucide="alert-circle" style="width: 32px; height: 32px; color: #DC2626;"></i>
                </div>
                <h3 style="margin: 0 0 0.5rem 0; color: var(--primary-dark);">Missing Required Fields</h3>
                <p style="margin: 0; color: var(--text-muted); font-size: 0.95rem;">Please fill in all required fields before saving.</p>
                <button onclick="this.closest('div').parentElement.remove()" style="margin-top: 1.5rem; padding: 0.75rem 1.5rem; background: var(--primary); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">OK</button>
            </div>
        `;
        document.body.appendChild(overlay);
        lucide.createIcons();
        return;
    }
    
    const btn = e.target.querySelector('button[type="submit"]');
    btn.textContent = 'Saving...';
    btn.disabled = true;

    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());
    data.mode = window.currentMode;

    try {
        const res = await fetch('/api/patients', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await res.json();

        if (result.success) {
            if (window.currentMode === 'identity') {
                window.patients.push(result.patient);
            } else {
                window.anonymizedPatients.push(result.patient);
            }
            window.selectPatient(result.patient.id);
            window.closeModal();
            e.target.reset();
        } else {
            alert("Error: " + result.message);
        }
    } catch (err) {
        console.error(err);
        alert("Network Error");
    } finally {
        btn.textContent = 'Save Patient';
        btn.disabled = false;
    }
};

// Excel Upload
window.downloadTemplate = function() {
    const headers = window.currentMode === 'identity' 
        ? ['Full Name', 'Patient ID', 'Medium of Contact', 'Contact Details', 'Age', 'Gender', 'Current Medication', 'Risk Level', 'Symptoms']
        : ['Anonymized Patient ID', 'Age Group', 'Gender', 'Risk Category', 'Observation Notes'];
    
    const sampleRow = window.currentMode === 'identity'
        ? ['Jane Doe', 'P-12345', 'Email', 'jane@example.com', '45', 'Female', 'Lisinopril', 'Medium', 'Dizziness']
        : ['ANON-12345', '31-45', 'Female', 'Medium', 'Observed symptoms'];
    
    const csv = [headers, sampleRow].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `patient-template-${window.currentMode}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
};

window.handleExcelUpload = async function() {
    const file = document.getElementById('excel-file').files[0];
    if (!file) {
        alert('Please select a file');
        return;
    }

    const formData = new FormData();
    formData.append('file', file);
    formData.append('mode', window.currentMode);

    try {
        const res = await fetch('/api/patients/upload', {
            method: 'POST',
            body: formData
        });
        const result = await res.json();

        if (result.success) {
            if (window.currentMode === 'identity') {
                window.patients.push(...result.patients);
            } else {
                window.anonymizedPatients.push(...result.patients);
            }
            window.renderList();
            window.closeModal();
            alert(`Successfully uploaded ${result.patients.length} patient(s)`);
        } else {
            alert("Error: " + result.message);
        }
    } catch (err) {
        console.error(err);
        alert("Upload failed");
    }
};

// Send follow-up email to patient
window.sendFollowupEmail = async function(patientId) {
    if (!confirm('Send a follow-up questionnaire email to this patient?')) {
        return;
    }
    
    try {
        const res = await fetch('/api/followup/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ patient_id: patientId })
        });
        
        const result = await res.json();
        
        if (result.success) {
            alert('✅ Follow-up email sent successfully!');
            // Refresh patient details
            window.renderDetail(patientId);
        } else if (result.setup_required) {
            alert('⚠️ Email not configured.\n\nTo send emails, set these environment variables:\n- GMAIL_ADDRESS\n- GMAIL_APP_PASSWORD\n\nSee the setup guide in pv_backend/services/followup_agent.py');
        } else {
            alert('❌ Error: ' + (result.error || result.message || 'Failed to send email'));
        }
    } catch (err) {
        console.error('Error sending follow-up email:', err);
        alert('Failed to send follow-up email. Please try again.');
    }
};

// Start
window.init();
</script></body></html>