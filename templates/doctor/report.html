<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Drug Experience - Doctor Dashboard</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script type="module" src="/static/js/sidebar.js"></script>
    <script src="/static/js/reports.js"></script>
    <style>
        .dashboard-layout { display: flex; }
        .main-content { flex: 1; margin-left: var(--sidebar-width); padding: 2rem; background-color: #FAFAF9; transition: margin-left 0.3s ease; overflow-y: auto; }
        body.sidebar-collapsed .main-content { margin-left: 80px; }
        .header { margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid #E2E8F0; }
        .header h1 { font-size: 2rem; color: var(--primary-dark); margin: 0; }
        .header p { color: var(--text-muted); margin: 0.5rem 0 0 0; font-size: 0.95rem; }
        .form-container { max-width: 800px; margin: 0 auto; }
        .section { background: white; border-radius: 12px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); }
        .section-title { font-size: 1.2rem; font-weight: 700; color: var(--primary-dark); margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.75rem; }
        .section-title i { color: var(--primary); }
        .helper-text { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 1.5rem; padding: 1rem; background-color: #F9FAFB; border-left: 4px solid var(--primary); border-radius: 6px; }
        .notice { padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; font-size: 0.95rem; }
        .notice-info { background-color: #EBF8FF; border-left: 4px solid #3B82F6; color: #1E40AF; }
        .notice-warning { background-color: #FEF3C7; border-left: 4px solid #F59E0B; color: #92400E; }
        .scope-selector { margin-bottom: 2rem; }
        .radio-group { display: flex; flex-direction: column; gap: 1rem; }
        .radio-option { display: flex; align-items: flex-start; gap: 1rem; padding: 1rem; border: 2px solid #E2E8F0; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .radio-option:hover { border-color: var(--primary); background-color: #F9FAFB; }
        .radio-option input[type="radio"] { margin-top: 0.25rem; cursor: pointer; }
        .radio-option.selected { border-color: var(--primary); background-color: #F0F7FF; }
        .radio-label { flex: 1; }
        .radio-label strong { display: block; color: var(--primary-dark); margin-bottom: 0.25rem; }
        .radio-label p { margin: 0; color: var(--text-muted); font-size: 0.9rem; }
        .form-group { margin-bottom: 1.5rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-main); font-size: 0.95rem; }
        .form-label .required { color: #DC2626; }
        .form-control { width: 100%; padding: 0.75rem; border: 1px solid #E2E8F0; border-radius: 8px; font-size: 0.95rem; transition: border-color 0.3s; }
        .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(58, 90, 122, 0.1); }
        .form-description { font-size: 0.85rem; color: var(--text-muted); margin-top: 0.5rem; }
        .patient-selection { display: flex; gap: 1rem; margin-bottom: 1rem; }
        .patient-selection button { flex: 1; padding: 0.75rem; border: 1px solid #E2E8F0; border-radius: 8px; background-color: white; color: var(--primary); font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .patient-selection button.active { background-color: var(--primary); color: white; border-color: var(--primary); }
        .patient-selection button:hover { border-color: var(--primary); }
        .hidden-section { display: none; }
        .hidden-section.show { display: block; }
        .button-group { display: flex; gap: 1rem; margin-top: 2rem; }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 0.95rem; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-dark); transform: translateY(-2px); }
        .btn-secondary { background-color: white; color: var(--primary); border: 1px solid #E2E8F0; }
        .btn-secondary:hover { background-color: var(--secondary); }
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background-color: white; padding: 2.5rem; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); text-align: center; }
        .modal-icon { font-size: 3rem; margin-bottom: 1rem; }
        .modal-icon.success { color: #10B981; }
        .modal-title { font-size: 1.5rem; font-weight: 700; color: var(--primary-dark); margin-bottom: 1rem; }
        .modal-message { color: var(--text-main); margin-bottom: 1.5rem; line-height: 1.6; }
        .modal-detail { background-color: #F9FAFB; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; font-size: 0.9rem; color: var(--text-muted); }
        .modal-btn { padding: 0.75rem 2rem; background-color: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .modal-btn:hover { background-color: var(--primary-dark); }
        .tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 2px solid #E2E8F0; }
        .tab-btn { padding: 1rem 1.5rem; background: none; border: none; font-weight: 600; color: var(--text-muted); cursor: pointer; transition: all 0.2s; border-bottom: 3px solid transparent; margin-bottom: -2px; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .history-table { width: 100%; border-collapse: collapse; }
        .history-table th { background-color: #F9FAFB; padding: 1rem; text-align: left; font-weight: 600; color: var(--primary-dark); font-size: 0.9rem; border-bottom: 2px solid #E2E8F0; }
        .history-table td { padding: 1rem; border-bottom: 1px solid #E2E8F0; }
        .history-table tbody tr:hover { background-color: #FAFAF9; }
        .status-badge { display: inline-block; padding: 0.4rem 0.8rem; border-radius: 6px; font-size: 0.8rem; font-weight: 600; }
        .status-submitted { background-color: #F0FDF4; color: #10B981; }
        .status-pending { background-color: #FFFBEB; color: #F59E0B; }
        .type-badge { display: inline-block; padding: 0.4rem 0.8rem; border-radius: 6px; font-size: 0.8rem; font-weight: 600; }
        .type-linked { background-color: #EBF8FF; color: #0C4A6E; }
        .type-anonymised { background-color: #F3E8FF; color: #5B21B6; }
        @media (max-width: 768px) { .main-content { padding: 1rem; } .section { padding: 1.5rem; } .patient-selection { flex-direction: column; } }
    </style>
</head>
<body>
    <div class="dashboard-layout">
        <app-sidebar></app-sidebar>
        <main class="main-content">
            <div class="header">
                <h1 style="text-align: center;">Report Drug Experience</h1>
                <p style="text-align: center;">Submit adverse effects, observations, or safety concerns</p>
            </div>

            <div class="form-container">
                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('report')">New Report</button>
                    <button class="tab-btn" onclick="switchTab('history')">Submission History</button>
                </div>

                <!-- Report Tab -->
                <div id="report" class="tab-content active">
                    <!-- Upload Option -->
                    <div class="section" style="background-color: #F0F7FF; border-left: 4px solid var(--primary);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0; color: var(--primary-dark);">Bulk Report Upload</h3>
                            <button class="btn btn-secondary" onclick="openExcelUploadModal()" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                                <i data-lucide="upload"></i> Upload Excel
                            </button>
                        </div>
                        <p style="margin: 0; color: var(--text-muted); font-size: 0.9rem;">Upload multiple drug experience reports at once using an Excel file with the correct format.</p>
                    </div>

                    <!-- STEP 1: Reporting Intent Selector -->
                    <div class="section">
                        <h2 class="section-title">
                            <i data-lucide="target"></i> Reporting Intent
                        </h2>
                        <p style="margin-bottom: 1.5rem; color: var(--text-muted); font-weight: 600;">This report is being submitted as:</p>
                        <div class="scope-selector">
                            <div class="radio-group">
                                <label class="radio-option" onclick="selectReportType('patient-linked')">
                                    <input type="radio" name="reportType" value="patient-linked" onchange="updateReportType('patient-linked')">
                                    <div class="radio-label">
                                        <strong>Patient-linked Report</strong>
                                        <p>Link this report to a specific patient in My Patients</p>
                                    </div>
                                </label>
                                <label class="radio-option selected" onclick="selectReportType('anonymised')">
                                    <input type="radio" name="reportType" value="anonymised" checked onchange="updateReportType('anonymised')">
                                    <div class="radio-label">
                                        <strong>Anonymised / Observational Report</strong>
                                        <p>No patient record will be created or linked</p>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 2: Patient Information Section -->
                    <div id="patientSection" class="section hidden-section">
                        <h2 class="section-title">
                            <i data-lucide="user"></i> Patient Information
                        </h2>
                        <div class="helper-text">
                            Patient information will be linked to your patient records.
                        </div>
                        <div class="form-group">
                            <label class="form-label">Select Patient</label>
                            <div class="patient-selection">
                                <button class="active" onclick="selectPatientMode('existing')">Select from My Patients</button>
                                <button onclick="selectPatientMode('manual')">Enter Manually</button>
                            </div>
                        </div>
                        <div id="existingPatientMode" class="form-group">
                            <select class="form-control" id="patientSelect">
                                <option value="">-- Select a patient --</option>
                                <option value="P001">P001 - Rajesh Kumar</option>
                                <option value="P002">P002 - Priya Sharma</option>
                                <option value="P003">P003 - Amit Patel</option>
                            </select>
                        </div>
                        <div id="manualPatientMode" class="hidden-section">
                            <div class="form-group">
                                <label class="form-label">Patient Name <span class="required">*</span></label>
                                <input type="text" class="form-control" placeholder="Full name">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Age <span class="required">*</span></label>
                                <input type="number" class="form-control" placeholder="Age" min="0" max="150">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Gender <span class="required">*</span></label>
                                <select class="form-control">
                                    <option value="">Select gender</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Anonymised Patient Section -->
                    <div id="anonymisedSection" class="section show">
                        <h2 class="section-title">
                            <i data-lucide="lock"></i> Anonymised Identifier
                        </h2>
                        <div class="helper-text">
                            No patient identity will be stored or linked. This report will be used for safety monitoring only.
                        </div>
                        <div class="form-group">
                            <label class="form-label">Anonymised ID (Optional)</label>
                            <input type="text" class="form-control" placeholder="e.g., ANON-2024-001 (system-generated if left blank)">
                            <p class="form-description">Leave blank for system-generated ID, or provide your own identifier</p>
                        </div>
                    </div>

                    <!-- STEP 3: Data Propagation Notice -->
                    <div id="propagationNotice" class="notice notice-info">
                        <strong>Data Storage:</strong> This report will be stored independently and will not create or update a patient record.
                    </div>

                    <!-- STEP 4: Drug Information Section -->
                    <div class="section">
                        <h2 class="section-title">
                            <i data-lucide="pill"></i> Drug Information
                        </h2>
                        <div class="helper-text">
                            Drug information is required for pharmacovigilance and safety analysis.
                        </div>
                        <div class="form-group">
                            <label class="form-label">Drug Name <span class="required">*</span></label>
                            <input type="text" class="form-control" placeholder="e.g., Aspirin, Metformin" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Drug Code / Batch Number</label>
                            <input type="text" class="form-control" placeholder="e.g., BATCH-2024-001">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Dosage <span class="required">*</span></label>
                            <input type="text" class="form-control" placeholder="e.g., 500mg" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Route of Administration <span class="required">*</span></label>
                            <select class="form-control" required>
                                <option value="">Select route</option>
                                <option value="oral">Oral</option>
                                <option value="injection">Injection</option>
                                <option value="topical">Topical</option>
                                <option value="inhalation">Inhalation</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Indication (Why prescribed)</label>
                            <input type="text" class="form-control" placeholder="e.g., Pain relief, Diabetes management">
                        </div>
                    </div>

                    <!-- STEP 5: Event Details Section -->
                    <div class="section">
                        <h2 class="section-title">
                            <i data-lucide="alert-circle"></i> Observed Events / Symptoms
                        </h2>
                        <div class="helper-text">
                            Describe observed symptoms, discomfort, lack of effect, or any notable observation. Reporting 'no adverse effects observed' is also valid.
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description <span class="required">*</span></label>
                            <textarea class="form-control" rows="5" placeholder="Describe what you observed..." required></textarea>
                            <p class="form-description">Be specific about timing, severity, and any actions taken</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Severity <span class="required">*</span></label>
                            <select id="severitySelect" class="form-control" required>
                                <option value="">Select severity</option>
                                <option value="Low">Low - Minor discomfort, no impact</option>
                                <option value="Medium">Medium - Moderate discomfort, manageable</option>
                                <option value="High">High - Significant impact, requires attention</option>
                                <option value="Critical">Critical - Severe/life-threatening</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Onset Date</label>
                            <input type="date" class="form-control">
                        </div>
                    </div>

                    <!-- STEP 6: Outcome Section -->
                    <div class="section">
                        <h2 class="section-title">
                            <i data-lucide="check-circle"></i> Outcome
                        </h2>
                        <div class="form-group">
                            <label class="form-label">Outcome <span class="required">*</span></label>
                            <select class="form-control" required>
                                <option value="">Select outcome</option>
                                <option value="recovered">Recovered</option>
                                <option value="recovering">Recovering</option>
                                <option value="not-recovered">Not Recovered</option>
                                <option value="fatal">Fatal</option>
                                <option value="unknown">Unknown</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-top: 1.5rem; margin-left: -2rem; padding-left: 2rem;">
                            <input type="checkbox" required style="flex-shrink: 0; width: 18px; height: 18px; cursor: pointer; margin: 0;">
                            <span style="color: var(--text-main); font-size: 0.95rem;">I consent to follow-up contact if necessary</span>
                        </div>
                        <p class="form-description" style="margin-left: 0;">Consent is required only if follow-up contact may be necessary.</p>
                    </div>

                    <!-- Submit Button -->
                    <div class="button-group">
                        <button type="button" class="btn btn-primary" onclick="submitReport()">
                            <i data-lucide="send"></i> Submit
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">
                            <i data-lucide="x"></i> Clear Form
                        </button>
                    </div>
                </div>

                <!-- History Tab -->
                <div id="history" class="tab-content">
                    <div class="section">
                        <h2 class="section-title">
                            <i data-lucide="history"></i> Submission History
                        </h2>
                        <table class="history-table">
                            <thead>
                                <tr>
                                    <th>Report Type</th>
                                    <th>Drug Name</th>
                                    <th>Date Submitted</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="historyBody">
                                <tr>
                                    <td><span class="type-badge type-anonymised">Anonymised</span></td>
                                    <td>Aspirin</td>
                                    <td>2024-01-25</td>
                                    <td><span class="status-badge status-submitted">Submitted</span></td>
                                </tr>
                                <tr>
                                    <td><span class="type-badge type-linked">Patient-linked</span></td>
                                    <td>Metformin</td>
                                    <td>2024-01-20</td>
                                    <td><span class="status-badge status-submitted">Submitted</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Submission Confirmation Modal -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <div class="modal-icon success">
                <i data-lucide="check-circle"></i>
            </div>
            <h2 class="modal-title">Report Submitted Successfully</h2>
            <p class="modal-message" id="confirmationMessage"></p>
            <div class="modal-detail" id="confirmationDetail"></div>
            <button class="modal-btn" onclick="closeConfirmation()">Done</button>
        </div>
    </div>

    <!-- Excel Upload Modal -->
    <div id="excelUploadModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 class="modal-title" style="margin: 0;">Upload Drug Experience Reports</h2>
                <button style="background: none; border: none; font-size: 1.5rem; color: var(--text-muted); cursor: pointer;" onclick="closeExcelUploadModal()">&times;</button>
            </div>

            <div id="uploadTypeSelection">
                <p style="margin-bottom: 1.5rem; color: var(--text-muted); font-weight: 600;">Select report type to upload:</p>
                <button class="btn btn-primary" style="width: 100%; margin-bottom: 1rem; justify-content: center;" onclick="selectUploadType('patient-linked')">
                    <i data-lucide="user"></i> Upload Patient-linked Reports
                </button>
                <button class="btn btn-secondary" style="width: 100%; justify-content: center;" onclick="selectUploadType('anonymised')">
                    <i data-lucide="lock"></i> Upload Anonymised Reports
                </button>
            </div>

            <form id="excelUploadForm" style="display: none;">
                <div class="form-group">
                    <label class="form-label">Select Excel File</label>
                    <input type="file" class="form-control" id="excelFile" accept=".xlsx,.xls" required>
                    <p class="form-description" id="requiredColumns"></p>
                </div>
                <div class="form-group">
                    <p style="background-color: #F9FAFB; padding: 1rem; border-radius: 8px; margin: 0; font-size: 0.9rem; color: var(--text-muted);">
                        <strong>Template Download:</strong> <a href="#" onclick="downloadTemplate(event)" style="color: var(--primary); text-decoration: none; font-weight: 600;">Download Excel Template</a>
                    </p>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-primary" style="flex: 1; justify-content: center;">Upload</button>
                    <button type="button" class="btn btn-secondary" style="flex: 1; justify-content: center;" onclick="closeExcelUploadModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { Auth } from '/static/js/auth.js';
        const user = Auth.requireAuth();
        lucide.createIcons();

        let currentReportType = 'anonymised';

        function selectReportType(type) {
            currentReportType = type;
            document.querySelectorAll('.radio-option').forEach(el => el.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            updateReportType(type);
        }

        function updateReportType(type) {
            currentReportType = type;
            const patientSection = document.getElementById('patientSection');
            const anonymisedSection = document.getElementById('anonymisedSection');
            const propagationNotice = document.getElementById('propagationNotice');

            if (type === 'patient-linked') {
                patientSection.classList.add('show');
                patientSection.classList.remove('hidden-section');
                anonymisedSection.classList.add('hidden-section');
                anonymisedSection.classList.remove('show');
                propagationNotice.innerHTML = '<strong>Data Storage:</strong> This report will be linked to the selected patient\'s record and visible in My Patients.';
                propagationNotice.className = 'notice notice-info';
            } else {
                patientSection.classList.add('hidden-section');
                patientSection.classList.remove('show');
                anonymisedSection.classList.add('show');
                anonymisedSection.classList.remove('hidden-section');
                propagationNotice.innerHTML = '<strong>Data Storage:</strong> This report will be stored independently and will not create or update a patient record.';
                propagationNotice.className = 'notice notice-info';
            }
        }

        function selectPatientMode(mode) {
            const existingMode = document.getElementById('existingPatientMode');
            const manualMode = document.getElementById('manualPatientMode');
            const buttons = document.querySelectorAll('.patient-selection button');

            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            if (mode === 'existing') {
                existingMode.classList.remove('hidden-section');
                manualMode.classList.add('hidden-section');
            } else {
                existingMode.classList.add('hidden-section');
                manualMode.classList.remove('hidden-section');
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            event.target.classList.add('active');
        }

        function submitReport() {
            console.log('submitReport() called, currentReportType:', currentReportType);
            
            // Check if report type is selected
            if (!currentReportType) {
                const errorModal = document.createElement('div');
                errorModal.className = 'modal show';
                errorModal.innerHTML = `
                    <div class="modal-content">
                        <h2 class="modal-title">Report Type Required</h2>
                        <p class="modal-message">Please select a report type (Patient-linked or Anonymised) before submitting.</p>
                        <button class="modal-btn" onclick="this.closest('.modal').remove()">OK</button>
                    </div>
                `;
                document.body.appendChild(errorModal);
                lucide.createIcons();
                return;
            }
            
            // Validate all required fields
            const requiredFields = [
                { selector: 'input[placeholder="e.g., Aspirin, Metformin"]', name: 'Drug Name' },
                { selector: 'input[placeholder="e.g., 500mg"]', name: 'Dosage' },
                { selector: 'select[required]', name: 'Route of Administration' },
                { selector: 'textarea[placeholder="Describe what you observed..."]', name: 'Description' },
                { selector: 'select[required]:last-of-type', name: 'Outcome' }
            ];

            let allFieldsFilled = true;
            let missingFields = [];

            // Check patient-linked specific fields
            if (currentReportType === 'patient-linked') {
                const patientSelect = document.getElementById('patientSelect');
                const manualMode = document.getElementById('manualPatientMode');
                
                if (manualMode.classList.contains('show')) {
                    const patientName = manualMode.querySelector('input[placeholder="Full name"]');
                    const age = manualMode.querySelector('input[placeholder="Age"]');
                    const gender = manualMode.querySelector('select');
                    
                    if (!patientName.value.trim()) missingFields.push('Patient Name');
                    if (!age.value) missingFields.push('Age');
                    if (!gender.value) missingFields.push('Gender');
                } else {
                    if (!patientSelect.value) missingFields.push('Patient Selection');
                }
            }

            // Check common required fields
            requiredFields.forEach(field => {
                const element = document.querySelector(field.selector);
                if (element && !element.value.trim()) {
                    missingFields.push(field.name);
                }
            });

            // Check consent checkbox
            const consentCheckbox = document.querySelector('input[type="checkbox"]');
            if (!consentCheckbox.checked) {
                missingFields.push('Consent');
            }

            if (missingFields.length > 0) {
                // Show error modal
                const errorModal = document.createElement('div');
                errorModal.className = 'modal show';
                errorModal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-icon" style="color: #DC2626;">
                            <i data-lucide="alert-circle"></i>
                        </div>
                        <h2 class="modal-title">Missing Required Fields</h2>
                        <p class="modal-message">Please fill in all required fields before submitting:</p>
                        <div class="modal-detail" style="text-align: left;">
                            ${missingFields.map(field => `<div style="padding: 0.5rem 0;">â€¢ ${field}</div>`).join('')}
                        </div>
                        <button class="modal-btn" onclick="this.closest('.modal').remove()">OK</button>
                    </div>
                `;
                document.body.appendChild(errorModal);
                lucide.createIcons();
                return;
            }

            // All fields filled - submit to database first
            const patientId = currentReportType === 'patient-linked' ? 
                (document.getElementById('existingPatientMode').classList.contains('show') ? 
                    document.getElementById('patientSelect').value : null) : null;
            
            submitReportToDatabase(currentReportType, patientId).then(success => {
                if (success) {
                    // Show success modal
                    const message = currentReportType === 'patient-linked'
                        ? 'This patient-linked report has been recorded and linked to the patient\'s record. It will appear in My Patients and may trigger alerts if severity thresholds are met.'
                        : 'This anonymised report has been recorded for safety monitoring. No patient record was created.';

                    const detail = currentReportType === 'patient-linked'
                        ? 'Report Type: Patient-linked | Visibility: My Patients, Alerts'
                        : 'Report Type: Anonymised | Visibility: Safety Analytics, Aggregate Alerts';

                    document.getElementById('confirmationMessage').textContent = message;
                    document.getElementById('confirmationDetail').textContent = detail;
                    document.getElementById('confirmationModal').classList.add('show');
                } else {
                    alert('Failed to submit report. Please try again.');
                }
            });
        }

        function closeConfirmation() {
            document.getElementById('confirmationModal').classList.remove('show');
            resetForm();
            // Refresh submission history
            loadSubmissionHistory();
        }

        function resetForm() {
            document.querySelectorAll('input[type="text"], input[type="date"], textarea, select').forEach(el => el.value = '');
            document.querySelector('input[type="checkbox"]').checked = false;
        }

        let currentUploadType = null;

        function openExcelUploadModal() {
            currentUploadType = null;
            document.getElementById('uploadTypeSelection').style.display = 'block';
            document.getElementById('excelUploadForm').style.display = 'none';
            document.getElementById('excelUploadModal').classList.add('show');
        }

        function closeExcelUploadModal() {
            document.getElementById('excelUploadModal').classList.remove('show');
            document.getElementById('excelFile').value = '';
            currentUploadType = null;
        }

        function selectUploadType(type) {
            currentUploadType = type;
            const columns = type === 'patient-linked'
                ? 'Patient Name, Age, Gender, Drug Name, Drug Code, Dosage, Route, Indication, Description, Onset Date, Outcome, Consent'
                : 'Anonymised ID, Drug Name, Drug Code, Dosage, Route, Indication, Description, Onset Date, Outcome, Consent';
            
            document.getElementById('requiredColumns').innerHTML = `<strong>Required columns:</strong> ${columns}`;
            document.getElementById('uploadTypeSelection').style.display = 'none';
            document.getElementById('excelUploadForm').style.display = 'block';
        }

        function downloadTemplate(e) {
            e.preventDefault();
            const type = currentUploadType || 'anonymised';
            
            if (type === 'patient-linked') {
                const headers = ['Patient Name', 'Age', 'Gender', 'Drug Name', 'Drug Code', 'Dosage', 'Route', 'Indication', 'Description', 'Onset Date', 'Outcome', 'Consent'];
                const sampleData = [
                    ['Rajesh Kumar', '45', 'Male', 'Aspirin', 'BATCH-001', '500mg', 'Oral', 'Pain relief', 'Mild headache after 2 hours', '2024-01-25', 'Recovered', 'Yes'],
                    ['Priya Sharma', '38', 'Female', 'Metformin', 'BATCH-002', '1000mg', 'Oral', 'Diabetes management', 'No adverse effects', '2024-01-24', 'Unknown', 'Yes']
                ];
                downloadCSV(headers, sampleData, 'Patient-linked_Reports_Template.csv');
            } else {
                const headers = ['Anonymised ID', 'Drug Name', 'Drug Code', 'Dosage', 'Route', 'Indication', 'Description', 'Onset Date', 'Outcome', 'Consent'];
                const sampleData = [
                    ['ANON-2024-001', 'Aspirin', 'BATCH-001', '500mg', 'Oral', 'Pain relief', 'Mild headache after 2 hours', '2024-01-25', 'Recovered', 'Yes'],
                    ['ANON-2024-002', 'Metformin', 'BATCH-002', '1000mg', 'Oral', 'Diabetes management', 'No adverse effects', '2024-01-24', 'Unknown', 'Yes']
                ];
                downloadCSV(headers, sampleData, 'Anonymised_Reports_Template.csv');
            }
        }

        function downloadCSV(headers, data, filename) {
            let csv = headers.join(',') + '\n';
            data.forEach(row => {
                csv += row.map(cell => `"${cell}"`).join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        document.getElementById('excelUploadForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const file = document.getElementById('excelFile').files[0];
            
            if (!file) {
                alert('Please select a file');
                return;
            }

            if (!file.name.match(/\.(xlsx|xls)$/)) {
                alert('Please upload an Excel file (.xlsx or .xls)');
                return;
            }

            alert(`Excel file "${file.name}" uploaded successfully for ${currentUploadType} reports. Processing...`);
            closeExcelUploadModal();
        });

        window.selectReportType = selectReportType;
        window.updateReportType = updateReportType;
        window.selectPatientMode = selectPatientMode;
        window.switchTab = switchTab;
        window.submitReport = submitReport;
        window.closeConfirmation = closeConfirmation;
        window.resetForm = resetForm;
        window.openExcelUploadModal = openExcelUploadModal;
        window.closeExcelUploadModal = closeExcelUploadModal;
        window.selectUploadType = selectUploadType;
        window.downloadTemplate = downloadTemplate;
    </script>
</body>
</html>
