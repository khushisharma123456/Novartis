<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharmacy Dashboard - Inteleyzer</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module" src="/static/js/sidebar.js"></script>
    <style>
        .dashboard-layout { display: flex; }
        .main-content { flex: 1; margin-left: var(--sidebar-width); padding: 2rem; background-color: #FAFAF9; transition: margin-left 0.3s ease; overflow-y: auto; }
        body.sidebar-collapsed .main-content { margin-left: 80px; }
        
        .header-section { margin-bottom: 2rem; }
        .header-section h1 { font-size: 2rem; color: var(--primary-dark); margin: 0; }
        .header-section p { color: var(--text-muted); margin: 0.5rem 0 0 0; font-size: 0.95rem; }
        
        .kpi-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .kpi-card { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); }
        .kpi-card h3 { margin: 0 0 0.5rem 0; font-size: 0.9rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .kpi-card .value { font-size: 2.5rem; font-weight: 700; color: var(--primary-dark); margin: 0.5rem 0 0 0; }
        .kpi-card.alert .value { color: #DC2626; }
        .kpi-card .icon { float: right; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; border-radius: 8px; }
        .kpi-card .icon i { width: 24px; height: 24px; }
        
        .section { background: white; border-radius: 12px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); }
        .section-title { font-size: 1.2rem; font-weight: 700; color: var(--primary-dark); margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.75rem; }
        .section-title i { color: var(--primary); }
        
        .attention-row { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border: 1px solid #FEE2E2; border-radius: 8px; background: #FFFBFB; margin-bottom: 1rem; }
        .attention-row:last-child { margin-bottom: 0; }
        .attention-row .drug-info { flex: 1; }
        .attention-row .drug-name { font-weight: 600; color: var(--primary-dark); margin-bottom: 0.25rem; }
        .attention-row .reason { font-size: 0.9rem; color: var(--text-muted); }
        .attention-row .severity { display: inline-block; padding: 0.4rem 0.8rem; border-radius: 6px; font-size: 0.8rem; font-weight: 600; margin: 0 1rem; }
        .severity-high { background: #FEE2E2; color: #7F1D1D; }
        .severity-critical { background: #DC2626; color: white; }
        .attention-row .action-btn { padding: 0.5rem 1rem; background: var(--primary); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.85rem; }
        .attention-row .action-btn:hover { background: var(--primary-dark); }
        
        .empty-state { text-align: center; padding: 2rem; color: var(--text-muted); }
        .empty-state i { font-size: 2.5rem; color: #D1D5DB; margin-bottom: 1rem; }
        
        .charts-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .chart-container { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); }
        .chart-container h3 { margin: 0 0 1rem 0; font-size: 1rem; font-weight: 600; color: var(--primary-dark); }
        
        .timeline-item { display: flex; gap: 1rem; padding: 1rem; border-left: 3px solid var(--primary); background: #F9FAFB; border-radius: 6px; margin-bottom: 1rem; }
        .timeline-item:last-child { margin-bottom: 0; }
        .timeline-icon { width: 40px; height: 40px; background: var(--secondary); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .timeline-content { flex: 1; }
        .timeline-content strong { display: block; color: var(--primary-dark); margin-bottom: 0.25rem; }
        .timeline-content p { margin: 0; font-size: 0.9rem; color: var(--text-muted); }
        .timeline-time { font-size: 0.8rem; color: var(--text-muted); }
        
        .compliance-box { background: linear-gradient(135deg, #F0F7FF 0%, #E0F2FE 100%); border-left: 4px solid var(--primary); padding: 1.5rem; border-radius: 8px; }
        .compliance-box h4 { margin: 0 0 1rem 0; color: var(--primary-dark); font-weight: 600; }
        .compliance-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid rgba(0, 0, 0, 0.05); }
        .compliance-item:last-child { border-bottom: none; }
        .compliance-item .label { color: var(--text-muted); font-size: 0.9rem; }
        .compliance-item .value { font-weight: 600; color: var(--primary-dark); }
        .status-badge { display: inline-block; padding: 0.3rem 0.6rem; border-radius: 4px; font-size: 0.8rem; font-weight: 600; }
        .status-uptodate { background: #F0FDF4; color: #10B981; }
        .status-action { background: #FFFBEB; color: #F59E0B; }
        
        .sort-controls { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
        .sort-btn { padding: 0.5rem 1rem; background: #F9FAFB; border: 1px solid #E2E8F0; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); transition: all 0.2s; }
        .sort-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .sort-btn:hover { border-color: var(--primary); }
        
        @media (max-width: 768px) { 
            .main-content { padding: 1rem; } 
            .kpi-row { grid-template-columns: repeat(2, 1fr); }
            .charts-row { grid-template-columns: 1fr; }
            .attention-row { flex-direction: column; align-items: flex-start; }
            .attention-row .severity { margin: 0.5rem 0; }
        }
    </style>
</head>
<body>
    <div class="dashboard-layout">
        <app-sidebar></app-sidebar>
        
        <main class="main-content">
            <!-- Header -->
            <div class="header-section">
                <h1>Pharmacy Dashboard</h1>
                <p>Welcome, <span id="pharmacy-name">Local Pharmacy</span></p>
            </div>

            <!-- Primary CTA -->
            <div style="margin-bottom: 2rem;">
                <button class="btn btn-primary" onclick="window.location.href='/pharmacy/report'" style="padding: 0.75rem 1.5rem; font-size: 1rem;">
                    <i data-lucide="plus"></i> Report ADR
                </button>
            </div>

            <!-- KPI Summary Row -->
            <div class="kpi-row">
                <div class="kpi-card">
                    <h3>Reports Filed Today</h3>
                    <div class="icon" style="background: var(--secondary); color: var(--primary-dark);">
                        <i data-lucide="file-text"></i>
                    </div>
                    <div class="value" id="stat-today">0</div>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.85rem; color: var(--text-muted);">Daily compliance</p>
                </div>
                
                <div class="kpi-card">
                    <h3>Total ADR Reports</h3>
                    <div class="icon" style="background: #E0F2FE; color: #0284C7;">
                        <i data-lucide="clipboard-list"></i>
                    </div>
                    <div class="value" id="stat-total">0</div>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.85rem; color: var(--text-muted);">Cumulative metric</p>
                </div>
                
                <div class="kpi-card alert">
                    <h3>High Priority Alerts</h3>
                    <div class="icon" style="background: #FEF2F2; color: #DC2626;">
                        <i data-lucide="alert-triangle"></i>
                    </div>
                    <div class="value" id="stat-alerts">0</div>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.85rem; color: var(--text-muted);">Requires attention</p>
                </div>
                
                <div class="kpi-card">
                    <h3>Dispensing Events</h3>
                    <div class="icon" style="background: #DCFCE7; color: #16A34A;">
                        <i data-lucide="package"></i>
                    </div>
                    <div class="value" id="stat-dispensing">0</div>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.85rem; color: var(--text-muted);">Data input volume</p>
                </div>
                
                <div class="kpi-card">
                    <h3>Compliance Score</h3>
                    <div class="icon" style="background: #F0FDF4; color: #10B981;">
                        <i data-lucide="shield-check"></i>
                    </div>
                    <div class="value" id="stat-compliance">--</div>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.85rem; color: var(--text-muted);" id="compliance-status-text">Loading...</p>
                </div>
            </div>

            <!-- Immediate Attention Section -->
            <div class="section" id="attention-section" style="display: none;">
                <h2 class="section-title">
                    <i data-lucide="alert-octagon"></i> Requires Immediate Attention
                </h2>
                <div id="attention-list"></div>
            </div>

            <!-- Charts Row -->
            <div class="charts-row">
                <!-- Reports by Severity -->
                <div class="chart-container">
                    <h3>Reports by Severity</h3>
                    <div id="severity-empty" class="empty-state" style="display: none;">
                        <i data-lucide="inbox"></i>
                        <p>No severity data available yet</p>
                    </div>
                    <canvas id="severityChart" style="display: none;"></canvas>
                </div>

                <!-- Top Reported Drugs -->
                <div class="chart-container">
                    <h3>Top Reported Drugs</h3>
                    <div class="sort-controls">
                        <button class="sort-btn active" onclick="sortDrugsBy('count')">By Count</button>
                        <button class="sort-btn" onclick="sortDrugsBy('severity')">By Severity</button>
                    </div>
                    <div id="drugs-empty" class="empty-state" style="display: none;">
                        <i data-lucide="inbox"></i>
                        <p>No drug data available yet</p>
                    </div>
                    <canvas id="drugsChart" style="display: none;"></canvas>
                </div>
            </div>

            <!-- Recent Activity Timeline -->
            <div class="section">
                <h2 class="section-title">
                    <i data-lucide="clock"></i> Recent Activity
                </h2>
                <div id="timeline-container">
                    <div class="empty-state">
                        <i data-lucide="inbox"></i>
                        <p>No recent activity yet</p>
                    </div>
                </div>
            </div>

            <!-- Compliance Status -->
            <div class="section">
                <h2 class="section-title">
                    <i data-lucide="shield-check"></i> Compliance Status
                </h2>
                <div class="compliance-box">
                    <h4>Reporting Status</h4>
                    <div class="compliance-item">
                        <span class="label">Last ADR Submission</span>
                        <span class="value" id="last-submission">Never</span>
                    </div>
                    <div class="compliance-item">
                        <span class="label">Status</span>
                        <span class="status-badge status-uptodate" id="compliance-status">âœ… Up to date</span>
                    </div>
                    <div class="compliance-item">
                        <span class="label">Total Reports This Month</span>
                        <span class="value" id="monthly-reports">0</span>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { Auth } from '/static/js/auth.js';

        const user = Auth.requireAuth();
        if (!user || user.role !== 'pharmacy') {
            window.location.href = '/login';
        }

        document.getElementById('pharmacy-name').textContent = user.name || 'Pharmacy';
        lucide.createIcons();

        let currentDrugSort = 'count';
        let drugsChartInstance = null;
        let severityChartInstance = null;

        // Load stats
        async function loadStats() {
            try {
                const response = await fetch('/api/pharmacy/stats');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('stat-today').textContent = data.today || 0;
                    document.getElementById('stat-total').textContent = data.total || 0;
                    document.getElementById('stat-alerts').textContent = data.alerts || 0;
                    document.getElementById('stat-dispensing').textContent = data.dispensing || 0;
                    document.getElementById('monthly-reports').textContent = data.monthlyReports || 0;
                    
                    // Set last submission date
                    if (data.lastSubmission) {
                        document.getElementById('last-submission').textContent = new Date(data.lastSubmission).toLocaleDateString();
                    }
                    
                    // Show/hide attention section
                    if (data.alerts && data.alerts > 0) {
                        loadAttentionAlerts();
                    }
                    
                    // Create charts
                    if (data.severity && (data.severity.low > 0 || data.severity.medium > 0 || data.severity.high > 0)) {
                        createSeverityChart(data.severity);
                    } else {
                        document.getElementById('severity-empty').style.display = 'block';
                    }
                    
                    if (data.topDrugs && data.topDrugs.length > 0) {
                        createDrugsChart(data.topDrugs);
                    } else {
                        document.getElementById('drugs-empty').style.display = 'block';
                    }
                    
                    // Load timeline
                    loadTimeline();
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
            
            // Load compliance score
            loadComplianceScore();
        }

        // Load compliance score
        async function loadComplianceScore() {
            try {
                const response = await fetch('/api/pharmacy/reports/compliance-score');
                const data = await response.json();
                
                if (data.success) {
                    const score = data.compliance_score;
                    const status = data.status;
                    
                    document.getElementById('stat-compliance').textContent = score;
                    
                    // Set status text with emoji
                    let statusEmoji = 'ðŸŸ¢';
                    if (score < 60) {
                        statusEmoji = 'ðŸ”´';
                    } else if (score < 80) {
                        statusEmoji = 'ðŸŸ¡';
                    }
                    
                    document.getElementById('compliance-status-text').textContent = `${statusEmoji} ${status}`;
                }
            } catch (error) {
                console.error('Error loading compliance score:', error);
                document.getElementById('compliance-status-text').textContent = 'Unable to load';
            }
        }

        // Load immediate attention alerts
        async function loadAttentionAlerts() {
            try {
                const response = await fetch('/api/pharmacy/alerts?priority=high');
                const data = await response.json();
                
                if (data.success && data.alerts && data.alerts.length > 0) {
                    const section = document.getElementById('attention-section');
                    const list = document.getElementById('attention-list');
                    
                    list.innerHTML = data.alerts.slice(0, 5).map(alert => `
                        <div class="attention-row">
                            <div class="drug-info">
                                <div class="drug-name">${alert.drugName}</div>
                                <div class="reason">${alert.reason}</div>
                            </div>
                            <span class="severity ${alert.severity === 'Critical' ? 'severity-critical' : 'severity-high'}">
                                ${alert.severity}
                            </span>
                            <button class="action-btn" onclick="acknowledgeAlert('${alert.id}')">
                                Acknowledge
                            </button>
                        </div>
                    `).join('');
                    
                    section.style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading alerts:', error);
            }
        }

        // Load recent activity timeline
        async function loadTimeline() {
            try {
                const response = await fetch('/api/pharmacy/activity?limit=5');
                const data = await response.json();
                
                if (data.success && data.activities && data.activities.length > 0) {
                    const container = document.getElementById('timeline-container');
                    
                    container.innerHTML = data.activities.map(activity => {
                        let icon = 'file-text';
                        if (activity.type === 'alert') icon = 'alert-circle';
                        if (activity.type === 'upload') icon = 'upload';
                        
                        return `
                            <div class="timeline-item">
                                <div class="timeline-icon">
                                    <i data-lucide="${icon}"></i>
                                </div>
                                <div class="timeline-content">
                                    <strong>${activity.title}</strong>
                                    <p>${activity.description}</p>
                                    <span class="timeline-time">${new Date(activity.timestamp).toLocaleString()}</span>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    lucide.createIcons();
                }
            } catch (error) {
                console.error('Error loading timeline:', error);
            }
        }

        function createSeverityChart(data) {
            const ctx = document.getElementById('severityChart');
            ctx.style.display = 'block';
            
            if (severityChartInstance) {
                severityChartInstance.destroy();
            }
            
            severityChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Mild', 'Moderate', 'Severe'],
                    datasets: [{
                        data: [data.low || 0, data.medium || 0, data.high || 0],
                        backgroundColor: ['#A3C9A8', '#E2C792', '#DCA5A5'],
                        borderWidth: 0
                    }]
                },
                options: {
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const labels = {
                                        'Mild': 'Minor symptoms, no intervention needed',
                                        'Moderate': 'Significant symptoms, monitoring required',
                                        'Severe': 'Serious adverse effects, immediate action needed'
                                    };
                                    return labels[context.label] || context.label;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createDrugsChart(data) {
            const ctx = document.getElementById('drugsChart');
            ctx.style.display = 'block';
            
            if (drugsChartInstance) {
                drugsChartInstance.destroy();
            }
            
            const sortedData = currentDrugSort === 'severity' 
                ? [...data].sort((a, b) => (b.severity || 0) - (a.severity || 0))
                : [...data].sort((a, b) => (b.count || 0) - (a.count || 0));
            
            drugsChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedData.slice(0, 5).map(d => d.name),
                    datasets: [{
                        label: 'Reports',
                        data: sortedData.slice(0, 5).map(d => d.count),
                        backgroundColor: '#3A5A7A',
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        window.sortDrugsBy = function(sortType) {
            currentDrugSort = sortType;
            document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Recreate chart with new sort
            fetch('/api/pharmacy/stats')
                .then(r => r.json())
                .then(data => {
                    if (data.topDrugs) {
                        createDrugsChart(data.topDrugs);
                    }
                });
        };

        window.acknowledgeAlert = function(alertId) {
            fetch(`/api/pharmacy/alerts/${alertId}/acknowledge`, { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        loadAttentionAlerts();
                    }
                });
        };

        // Load data on page load
        loadStats();
    </script>
</body>
</html>
