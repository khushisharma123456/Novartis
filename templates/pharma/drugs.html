<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drug Management - Inteleyzer</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script type="module" src="/static/js/sidebar.js"></script>
</head>
<body>
    <div class="dashboard-layout">
        <app-sidebar></app-sidebar>
        <main class="main-content">
            <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <div>
                    <h1>Drug Portfolio</h1>
                    <p>Manage your company's drug catalog with AI-powered risk assessment</p>
                </div>
                <button class="btn btn-primary" id="btn-add-drug">+ Add Drug</button>
            </header>

            <div id="drugs-list" style="display: flex; flex-direction: column; gap: 1.5rem;">
                <p style="text-align: center; padding: 2rem;">Loading drugs...</p>
            </div>
        </main>
    </div>

    <!-- Add Drug Modal -->
    <div class="modal-overlay" id="add-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Add New Drug</h3>
                <button class="close-modal" style="background:none; border:none; cursor:pointer;">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <form id="add-drug-form">
                <div class="form-group">
                    <label>Drug Name</label>
                    <input type="text" name="name" required placeholder="e.g. Paracetamol">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea name="description" placeholder="Brief description of the drug" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Active Ingredients</label>
                    <textarea name="activeIngredients" required placeholder="List active ingredients" rows="2"></textarea>
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                    <button type="button" class="btn btn-outline close-modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Drug</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Send Alert Modal -->
    <div class="modal-overlay" id="alert-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Send Safety Alert</h3>
                <button class="close-alert-modal" style="background:none; border:none; cursor:pointer;">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <form id="send-alert-form">
                <input type="hidden" name="drugName" id="alert-drug-name">
                <div class="form-group">
                    <label>Drug Name</label>
                    <input type="text" id="alert-drug-display" readonly style="background: #F5F5F0;">
                </div>
                <div class="form-group">
                    <label>Severity</label>
                    <select name="severity">
                        <option value="Low">Low</option>
                        <option value="Medium" selected>Medium</option>
                        <option value="High">High</option>
                        <option value="Critical">Critical</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Alert Message</label>
                    <textarea name="message" required placeholder="Describe the safety concern..." rows="4"></textarea>
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                    <button type="button" class="btn btn-outline close-alert-modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send Alert to All Doctors</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { Auth } from '/static/js/auth.js';
        Auth.requireAuth();
        lucide.createIcons();

        let drugs = [];
        const modal = document.getElementById('add-modal');
        const alertModal = document.getElementById('alert-modal');

        // Load drugs
        async function loadDrugs() {
            try {
                const response = await fetch('/api/drugs');
                if (response.ok) {
                    drugs = await response.json();
                    renderDrugs();
                }
            } catch (error) {
                console.error('Error loading drugs:', error);
                document.getElementById('drugs-list').innerHTML = '<p style="text-align:center; color:red;">Failed to load drugs.</p>';
            }
        }

        function renderDrugs() {
            const container = document.getElementById('drugs-list');
            
            if (drugs.length === 0) {
                container.innerHTML = '<div class="card"><p style="text-align:center; padding: 2rem;">No drugs found. Add your first drug to get started.</p></div>';
                return;
            }

            container.innerHTML = drugs.map(drug => `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                        <div style="flex: 1;">
                            <h3 style="margin-bottom: 0.5rem;">${drug.name}</h3>
                            <p style="color: var(--text-muted); margin-bottom: 1rem;">${drug.description || 'No description provided'}</p>
                            <p style="font-size: 0.9rem;"><strong>Active Ingredients:</strong> ${drug.activeIngredients || 'Not specified'}</p>
                        </div>
                        <div style="text-align: right;">
                            <span class="badge badge-${drug.aiRiskAssessment.toLowerCase()}" style="margin-bottom: 0.5rem;">
                                ${drug.aiRiskAssessment} Risk
                            </span>
                            <button class="btn btn-outline" onclick="window.sendAlert('${drug.name}')" style="margin-top: 0.5rem; padding: 0.5rem 1rem; font-size: 0.85rem;">
                                <i data-lucide="alert-triangle" style="width: 14px; height: 14px;"></i>
                                Send Alert
                            </button>
                        </div>
                    </div>
                    <div style="background: var(--secondary); padding: 1rem; border-radius: 8px; border-left: 4px solid var(--primary);">
                        <div style="display: flex; align-items: start; gap: 0.5rem;">
                            <i data-lucide="bot" style="width: 20px; height: 20px; color: var(--primary); flex-shrink: 0; margin-top: 2px;"></i>
                            <div>
                                <strong style="color: var(--primary);">AI Risk Analysis:</strong>
                                <p style="margin-top: 0.5rem; font-size: 0.9rem;">${drug.aiRiskDetails || 'Analysis in progress...'}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            lucide.createIcons();
        }

        // Modal controls
        document.getElementById('btn-add-drug').addEventListener('click', () => modal.classList.add('active'));
        document.querySelectorAll('.close-modal').forEach(btn => btn.addEventListener('click', () => modal.classList.remove('active')));
        document.querySelectorAll('.close-alert-modal').forEach(btn => btn.addEventListener('click', () => alertModal.classList.remove('active')));

        // Add drug form
        document.getElementById('add-drug-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch('/api/drugs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    drugs.push(result.drug);
                    renderDrugs();
                    modal.classList.remove('active');
                    e.target.reset();
                } else {
                    alert('Error: ' + (result.message || 'Failed to create drug'));
                }
            } catch (error) {
                console.error('Error creating drug:', error);
                alert('Network error: ' + error.message);
            }
        });

        // Send alert function
        window.sendAlert = function(drugName) {
            document.getElementById('alert-drug-name').value = drugName;
            document.getElementById('alert-drug-display').value = drugName;
            alertModal.classList.add('active');
        };

        // Send alert form
        document.getElementById('send-alert-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch('/api/alerts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    alert('Alert sent successfully to all doctors!');
                    alertModal.classList.remove('active');
                    e.target.reset();
                } else {
                    alert('Error: ' + (result.message || 'Failed to send alert'));
                }
            } catch (error) {
                console.error('Error sending alert:', error);
                alert('Network error: ' + error.message);
            }
        });

        loadDrugs();
    </script>
</body>
</html>
