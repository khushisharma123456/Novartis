<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safety Overview - Inteleyzer</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module" src="/static/js/sidebar.js"></script>
    <style>
        .dashboard-layout { display: flex; }
        .main-content { flex: 1; margin-left: var(--sidebar-width); padding: 2rem; background-color: #FAFAF9; transition: margin-left 0.3s ease; overflow-y: auto; }
        body.sidebar-collapsed .main-content { margin-left: 80px; }
        
        header { margin-bottom: 1.5rem; }
        header h1 { font-size: 2rem; color: var(--primary-dark); margin: 0; text-align: center; }
        header p { color: var(--text-muted); margin: 0.5rem 0 0 0; font-size: 0.95rem; text-align: center; }
        
        .scope-box { background: white; border-left: 4px solid var(--primary); padding: 1rem; border-radius: 8px; margin-bottom: 2rem; display: flex; gap: 1rem; font-size: 0.9rem; color: #0C4A6E; }
        .scope-box-icon { font-size: 1.2rem; flex-shrink: 0; }
        .scope-box-content { flex: 1; }
        .scope-box-content strong { color: var(--primary-dark); }
        .scope-box-content a { color: var(--primary); text-decoration: none; font-weight: 600; }
        .scope-box-content a:hover { text-decoration: underline; }
        
        .urgent-strip { background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%); border-left: 4px solid #DC2626; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; display: flex; align-items: center; gap: 1rem; }
        .urgent-strip.safe { background: linear-gradient(135deg, #DCFCE7 0%, #BBFBEE 100%); border-left-color: #16A34A; }
        .urgent-strip-icon { font-size: 1.5rem; }
        .urgent-strip-content h3 { margin: 0; color: var(--primary-dark); font-size: 1.1rem; }
        .urgent-strip-content p { margin: 0.25rem 0 0 0; color: var(--text-muted); font-size: 0.9rem; }
        
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .kpi-card { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); }
        .kpi-label { font-size: 0.9rem; color: var(--text-muted); margin: 0; font-weight: 500; }
        .kpi-helper { font-size: 0.8rem; color: var(--text-muted); margin: 0.5rem 0 0 0; }
        .kpi-value { font-size: 2.5rem; font-weight: 700; margin: 0.75rem 0 0 0; color: var(--primary-dark); }
        .kpi-badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; margin-top: 0.75rem; }
        .kpi-badge.red { background: #FEE2E2; color: #991B1B; }
        .kpi-badge.amber { background: #FEF3C7; color: #92400E; }
        .kpi-badge.green { background: #DCFCE7; color: #166534; }
        
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .card { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); }
        .card h3 { margin: 0 0 0.25rem 0; color: var(--primary-dark); font-size: 1.1rem; }
        .card-subtitle { font-size: 0.85rem; color: var(--text-muted); margin: 0 0 1rem 0; }
        .card-empty { text-align: center; padding: 2rem; color: var(--text-muted); }
        
        .signals-section { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); }
        .signals-section h3 { margin: 0 0 0.25rem 0; color: var(--primary-dark); font-size: 1.1rem; }
        .signals-helper { font-size: 0.85rem; color: var(--text-muted); margin: 0 0 1rem 0; }
        
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        thead tr { border-bottom: 2px solid #E2E8F0; }
        th { padding: 1rem; text-align: left; font-weight: 600; color: var(--text-muted); font-size: 0.9rem; }
        td { padding: 1rem; border-bottom: 1px solid #F1F5F9; }
        tbody tr { cursor: pointer; transition: background-color 0.2s; }
        tbody tr:hover { background-color: #F9FAFB; }
        tbody tr.high-risk { background-color: #FEF2F2; }
        tbody tr.medium-risk { background-color: #FFFBEB; }
        
        .badge { display: inline-block; padding: 0.35rem 0.75rem; border-radius: 6px; font-size: 0.8rem; font-weight: 600; }
        .badge-high { background: #FEE2E2; color: #991B1B; }
        .badge-medium { background: #FEF3C7; color: #92400E; }
        .badge-low { background: #DCFCE7; color: #166534; }
        .badge-review { background: #FEF3C7; color: #92400E; }
        .badge-resolved { background: #DCFCE7; color: #166534; }
        
        .no-data { text-align: center; padding: 2rem; color: var(--text-muted); }
        
        /* Skeleton Loaders */
        .skeleton { background: linear-gradient(90deg, #F3F4F6 25%, #E5E7EB 50%, #F3F4F6 75%); background-size: 200% 100%; animation: loading 1.5s infinite; border-radius: 6px; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        
        .skeleton-kpi { height: 120px; margin-bottom: 1rem; }
        .skeleton-chart { height: 250px; margin-bottom: 1rem; }
        .skeleton-row { height: 50px; margin-bottom: 0.5rem; }
        
        .navigation-hint { background: #F0F7FF; border-left: 4px solid var(--primary); padding: 0.75rem 1rem; border-radius: 6px; margin-top: 1rem; font-size: 0.85rem; color: #0C4A6E; }
        .navigation-hint strong { color: var(--primary-dark); }
        .navigation-hint a { color: var(--primary); text-decoration: none; font-weight: 600; }
        .navigation-hint a:hover { text-decoration: underline; }
        
        @media (max-width: 768px) {
            .main-content { padding: 1rem; }
            .kpi-grid { grid-template-columns: 1fr; }
            .charts-grid { grid-template-columns: 1fr; }
            .urgent-strip { flex-direction: column; align-items: flex-start; }
            .scope-box { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="dashboard-layout">
        <app-sidebar></app-sidebar>
        
        <main class="main-content">
            <header>
                <h1>Safety Overview</h1>
                <p>Portfolio-wide safety intelligence and signal monitoring</p>
            </header>

            <!-- Urgent Attention Strip -->
            <div class="urgent-strip" id="urgent-strip">
                <div class="urgent-strip-icon">‚ö†Ô∏è</div>
                <div class="urgent-strip-content">
                    <h3>Urgent Safety Attention Required</h3>
                    <p id="urgent-message">Checking for critical signals...</p>
                </div>
            </div>

            <!-- Portfolio-Level KPIs -->
            <div class="kpi-grid">
                <div class="kpi-card">
                    <p class="kpi-label">üî¥ Signals Requiring Review</p>
                    <p class="kpi-helper">High-priority safety signals across all drugs</p>
                    <h2 class="kpi-value" id="stat-high">
                        <span class="skeleton skeleton-kpi" style="display: inline-block; width: 60px; height: 40px;"></span>
                    </h2>
                    <span class="kpi-badge red">High Priority</span>
                </div>
                <div class="kpi-card">
                    <p class="kpi-label">üü° Signals Under Monitoring</p>
                    <p class="kpi-helper">Signals currently being observed across the portfolio</p>
                    <h2 class="kpi-value" id="stat-medium">
                        <span class="skeleton skeleton-kpi" style="display: inline-block; width: 60px; height: 40px;"></span>
                    </h2>
                    <span class="kpi-badge amber">Medium Priority</span>
                </div>
                <div class="kpi-card">
                    <p class="kpi-label">üü¢ Resolved Signals</p>
                    <p class="kpi-helper">Closed safety signals across all drugs</p>
                    <h2 class="kpi-value" id="stat-low">
                        <span class="skeleton skeleton-kpi" style="display: inline-block; width: 60px; height: 40px;"></span>
                    </h2>
                    <span class="kpi-badge green">Closed</span>
                </div>
            </div>

            <!-- Charts Section -->
            <h2 style="font-size: 1.1rem; color: var(--primary-dark); margin: 2rem 0 1.5rem 0; font-weight: 600;">Portfolio Safety Analytics</h2>
            <div class="charts-grid">
                <div class="card">
                    <h3>Signal Severity Distribution</h3>
                    <p class="card-subtitle">Distribution of safety signals by severity across the entire portfolio.</p>
                    <div class="skeleton skeleton-chart" id="severity-skeleton"></div>
                    <canvas id="severityChart" style="display: none;"></canvas>
                    <div class="card-empty" id="severity-empty" style="display: none;">No signals available yet.</div>
                </div>
                <div class="card">
                    <h3>Most Affected Age Groups</h3>
                    <p class="card-subtitle">Age-group distribution across all reported safety signals.</p>
                    <div class="skeleton skeleton-chart" id="age-skeleton"></div>
                    <canvas id="ageChart" style="display: none;"></canvas>
                    <div class="card-empty" id="age-empty" style="display: none;">No demographic data available.</div>
                </div>
            </div>

            <!-- Recent Signals Feed -->
            <section class="signals-section">
                <h3>Recent Safety Signals (Portfolio-Wide)</h3>
                <p class="signals-helper">Recent safety signals detected across the portfolio.</p>
                <div class="navigation-hint">
                    <strong>üí° Navigation Tip:</strong> Click a signal to view details. For drug-specific analysis, visit <a href="/pharma/drugs">Drug Portfolio</a>.
                </div>
                <div class="table-container" style="margin-top: 1rem;">
                    <table>
                        <thead>
                            <tr>
                                <th>Signal ID</th>
                                <th>Drug</th>
                                <th>Event / Symptom</th>
                                <th>Severity</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="signals-table">
                            <tr>
                                <td colspan="5">
                                    <div style="padding: 1rem;">
                                        <div class="skeleton skeleton-row"></div>
                                        <div class="skeleton skeleton-row"></div>
                                        <div class="skeleton skeleton-row"></div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <script type="module">
        import { PharmaApp } from '/static/js/pharma.js';
        import { Auth } from '/static/js/auth.js';

        Auth.requireAuth();
        lucide.createIcons();

        async function init() {
            // Fetch Stats
            const stats = await PharmaApp.getAggregateStats();
            
            // Update KPIs with portfolio-wide labels
            document.getElementById('stat-high').textContent = stats.riskDist.high;
            document.getElementById('stat-medium').textContent = stats.riskDist.medium;
            document.getElementById('stat-low').textContent = stats.riskDist.low;

            // Update urgent attention strip
            updateUrgentStrip(stats);

            // Render Charts
            renderCharts(stats);

            // Fetch Recent List
            const patients = await PharmaApp.getAllData();
            const recent = patients.slice(-10).reverse(); // Last 10

            const table = document.getElementById('signals-table');

            if (recent.length === 0) {
                table.innerHTML = '<tr><td colspan="5" style="padding: 2rem; text-align: center; color: var(--text-muted);"><div style="font-size: 2rem; margin-bottom: 0.5rem;">üì≠</div><strong>No signals detected yet</strong><p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">Safety signals will appear here as they are reported across the portfolio.</p></td></tr>';
            } else {
                table.innerHTML = recent.map(p => {
                    const riskClass = p.riskLevel.toLowerCase();
                    const rowClass = riskClass === 'high' ? 'high-risk' : riskClass === 'medium' ? 'medium-risk' : '';
                    const statusBadge = riskClass === 'high' ? 'review' : riskClass === 'medium' ? 'review' : 'resolved';
                    return `
                        <tr class="${rowClass}" onclick="openSignalDetail('${p.id}')">
                            <td style="font-weight: 600; color: var(--primary);">${p.id}</td>
                            <td>${p.drugName}</td>
                            <td>${p.symptoms || 'Not specified'}</td>
                            <td>
                                <span class="badge badge-${riskClass}">
                                    ${p.riskLevel}
                                </span>
                            </td>
                            <td>
                                <span class="badge badge-${statusBadge}">
                                    ${riskClass === 'high' ? 'Under Review' : riskClass === 'medium' ? 'Under Review' : 'Resolved'}
                                </span>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
        }

        function updateUrgentStrip(stats) {
            const strip = document.getElementById('urgent-strip');
            const message = document.getElementById('urgent-message');
            
            if (stats.riskDist.high > 0) {
                strip.classList.remove('safe');
                message.textContent = `${stats.riskDist.high} high-priority signal${stats.riskDist.high > 1 ? 's' : ''} require${stats.riskDist.high > 1 ? '' : 's'} immediate attention across the portfolio`;
            } else {
                strip.classList.add('safe');
                strip.innerHTML = '<div class="urgent-strip-icon">‚úÖ</div><div class="urgent-strip-content"><h3>No Urgent Safety Risks</h3><p>All monitored signals across the portfolio are within acceptable thresholds.</p></div>';
            }
        }

        function renderCharts(stats) {
            const hasData = stats.riskDist.low > 0 || stats.riskDist.medium > 0 || stats.riskDist.high > 0;
            
            // Signal Severity Distribution Chart
            const severityCtx = document.getElementById('severityChart');
            const severityEmpty = document.getElementById('severity-empty');
            const severitySkeleton = document.getElementById('severity-skeleton');
            
            if (hasData) {
                severityEmpty.style.display = 'none';
                severitySkeleton.style.display = 'none';
                severityCtx.style.display = 'block';
                new Chart(severityCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Mild', 'Moderate', 'Severe'],
                        datasets: [{
                            data: [stats.riskDist.low, stats.riskDist.medium, stats.riskDist.high],
                            backgroundColor: ['#DCFCE7', '#FEF3C7', '#FEE2E2'],
                            borderColor: ['#16A34A', '#D97706', '#DC2626'],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            } else {
                severityCtx.style.display = 'none';
                severitySkeleton.style.display = 'none';
                severityEmpty.style.display = 'block';
            }

            // Age Distribution Chart (Portfolio-wide)
            const ageCtx = document.getElementById('ageChart');
            const ageEmpty = document.getElementById('age-empty');
            const ageSkeleton = document.getElementById('age-skeleton');
            
            if (hasData) {
                ageEmpty.style.display = 'none';
                ageSkeleton.style.display = 'none';
                ageCtx.style.display = 'block';
                new Chart(ageCtx, {
                    type: 'bar',
                    data: {
                        labels: ['0-18', '19-40', '41-60', '60+'],
                        datasets: [{
                            label: 'Signals',
                            data: [
                                Math.floor(stats.genderDist.male * 0.15),
                                Math.floor(stats.genderDist.male * 0.35),
                                Math.floor(stats.genderDist.male * 0.35),
                                Math.floor(stats.genderDist.male * 0.15)
                            ],
                            backgroundColor: '#3A5A7A',
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            } else {
                ageCtx.style.display = 'none';
                ageSkeleton.style.display = 'none';
                ageEmpty.style.display = 'block';
            }
        }

        window.openSignalDetail = function(signalId) {
            // Placeholder for signal detail view
            console.log('Opening signal detail:', signalId);
            // In a real app, this would navigate to a signal detail page or open a modal
            // NOT to drug detail - this is a signal-level view
        };

        init();
    </script>
</body>
</html>
