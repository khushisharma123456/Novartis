<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharma Settings - Inteleyzer</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script type="module" src="/static/js/sidebar.js"></script>
    <style>
        .dashboard-layout { display: flex; }
        .main-content { flex: 1; margin-left: var(--sidebar-width); padding: 2rem; background-color: #FAFAF9; transition: margin-left 0.3s ease; overflow-y: auto; }
        body.sidebar-collapsed .main-content { margin-left: 80px; }
        
        .header { margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid #E2E8F0; }
        .header h1 { font-size: 2rem; color: var(--primary-dark); margin: 0; text-align: center; }
        .header p { color: var(--text-muted); margin: 0.5rem 0 0 0; font-size: 0.95rem; text-align: center; }
        
        .settings-container { max-width: 800px; margin: 0 auto; }
        
        .settings-section { background: white; border-radius: 12px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); }
        .settings-section h2 { font-size: 1.2rem; font-weight: 700; color: var(--primary-dark); margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.75rem; }
        .settings-section h2 i { color: var(--primary); }
        
        .form-group { margin-bottom: 1.5rem; }
        .form-group:last-child { margin-bottom: 0; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-main); font-size: 0.95rem; }
        .form-label .required { color: #DC2626; }
        .form-control { width: 100%; padding: 0.75rem; border: 1px solid #E2E8F0; border-radius: 8px; font-size: 0.95rem; transition: border-color 0.3s; box-sizing: border-box; }
        .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(58, 90, 122, 0.1); }
        .form-control:disabled { background-color: #F3F4F6; color: #9CA3AF; cursor: not-allowed; }
        .form-description { font-size: 0.85rem; color: var(--text-muted); margin-top: 0.5rem; }
        
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        
        .checkbox-group { display: flex; align-items: center; gap: 0.75rem; margin: 1rem 0; }
        .checkbox-group input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .checkbox-group label { cursor: pointer; margin: 0; }
        
        .button-group { display: flex; gap: 1rem; margin-top: 2rem; justify-content: flex-end; }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 0.95rem; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-dark); transform: translateY(-2px); }
        .btn-secondary { background-color: white; color: var(--primary); border: 1px solid #E2E8F0; }
        .btn-secondary:hover { background-color: var(--secondary); }
        
        .success-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .success-modal.show { opacity: 1; pointer-events: all; }
        .modal-content { background: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 350px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); text-align: center; }
        .success-checkmark { width: 80px; height: 80px; margin: 0 auto 1.5rem; background: #10B981; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .success-checkmark svg { width: 48px; height: 48px; stroke: white; stroke-width: 2; fill: none; stroke-linecap: round; stroke-linejoin: round; }
        .modal-content h3 { margin-top: 0; color: var(--primary-dark); }
        .modal-content p { color: var(--text-muted); margin: 0.5rem 0 0 0; }
        
        .error-box { background: #FEE2E2; border-left: 4px solid #DC2626; padding: 1rem; border-radius: 6px; color: #7F1D1D; margin-bottom: 1rem; display: none; }
        
        .divider { border-top: 1px solid #E2E8F0; margin: 2rem 0; }
        
        .info-box { background: #F0F7FF; border-left: 4px solid var(--primary); padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem; font-size: 0.9rem; color: #0C4A6E; }
        
        @media (max-width: 768px) {
            .main-content { padding: 1rem; }
            .settings-section { padding: 1.5rem; }
            .form-row { grid-template-columns: 1fr; }
            .button-group { flex-direction: column; }
            .btn { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>
    <div class="dashboard-layout">
        <app-sidebar></app-sidebar>
        
        <main class="main-content">
            <div class="header">
                <h1 style="text-align: center;">Settings</h1>
                <p style="text-align: center;">Manage your pharmaceutical company account and preferences</p>
            </div>

            <div class="settings-container">
                <!-- Error Box -->
                <div class="error-box" id="error-box"></div>

                <!-- Company Settings Section -->
                <div class="settings-section">
                    <h2>
                        <i data-lucide="building-2"></i> Company Information
                    </h2>
                    <div class="info-box">
                        Your company details are used for drug portfolio management and regulatory compliance.
                    </div>
                    <form id="company-form" onsubmit="handleCompanySubmit(event)">
                        <div class="form-group">
                            <label class="form-label">Company Name <span class="required">*</span></label>
                            <input type="text" class="form-control" id="company-name" required placeholder="e.g., Novartis Pharmaceuticals">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Email Address <span class="required">*</span></label>
                                <input type="email" class="form-control" id="company-email" readonly style="background-color: #F3F4F6; cursor: not-allowed;">
                                <p class="form-description">Your account email address (cannot be changed)</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="company-phone" placeholder="e.g., +1 (555) 123-4567">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Headquarters Address</label>
                            <input type="text" class="form-control" id="company-address" placeholder="e.g., 123 Pharma Boulevard, Basel, Switzerland">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Registration Number</label>
                            <input type="text" class="form-control" id="company-registration" placeholder="e.g., REG-2024-001234">
                        </div>
                        
                        <div class="button-group">
                            <button type="button" class="btn btn-secondary" onclick="resetCompanyForm()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                </div>

                <!-- Data Sharing & Compliance Section -->
                <div class="settings-section">
                    <h2>
                        <i data-lucide="shield-lock"></i> Data Sharing & Compliance
                    </h2>
                    <div class="info-box">
                        Control how your drug safety data is shared with regulatory authorities and healthcare providers.
                    </div>
                    <form id="compliance-form" onsubmit="handleComplianceSubmit(event)">
                        <div class="form-group">
                            <label class="form-label">Data Sharing Preferences</label>
                            <div class="checkbox-group">
                                <input type="checkbox" id="share-adr-reports" checked>
                                <label for="share-adr-reports">Share ADR reports with regulatory authorities</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="share-safety-data" checked>
                                <label for="share-safety-data">Share safety data with healthcare providers</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="anonymize-reports">
                                <label for="anonymize-reports">Anonymize patient data in reports (recommended)</label>
                            </div>
                        </div>
                        
                        <div class="divider"></div>
                        
                        <div class="form-group">
                            <label class="form-label">Primary Regulatory Authority</label>
                            <select class="form-control" id="regulatory-authority">
                                <option value="">Select authority...</option>
                                <option value="FDA">FDA (United States)</option>
                                <option value="EMA">EMA (European Union)</option>
                                <option value="PMDA">PMDA (Japan)</option>
                                <option value="NMPA">NMPA (China)</option>
                                <option value="Health Canada">Health Canada</option>
                                <option value="TGA">TGA (Australia)</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Data Retention Period</label>
                            <select class="form-control" id="retention-period">
                                <option value="12">12 months</option>
                                <option value="24" selected>24 months (default)</option>
                                <option value="36">36 months</option>
                                <option value="60">5 years</option>
                            </select>
                            <p class="form-description">How long to retain safety data before archival</p>
                        </div>
                        
                        <div class="button-group">
                            <button type="button" class="btn btn-secondary" onclick="resetComplianceForm()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Preferences</button>
                        </div>
                    </form>
                </div>

                <!-- Notification Preferences Section -->
                <div class="settings-section">
                    <h2>
                        <i data-lucide="bell"></i> Notification Preferences
                    </h2>
                    <div class="info-box">
                        Choose how you receive alerts about adverse events and safety updates.
                    </div>
                    <form id="notification-form" onsubmit="handleNotificationSubmit(event)">
                        <div class="form-group">
                            <label class="form-label">Alert Frequency</label>
                            <select class="form-control" id="alert-frequency">
                                <option value="immediate" selected>Immediate - Get alerts as they occur</option>
                                <option value="daily">Daily Digest - Receive one summary each morning</option>
                                <option value="weekly">Weekly Summary - Receive alerts once per week</option>
                            </select>
                            <p class="form-description">⚠️ Critical safety alerts are always delivered immediately</p>
                        </div>
                        
                        <div class="divider"></div>
                        
                        <div class="form-group">
                            <label class="form-label">Notification Channels</label>
                            <div class="checkbox-group">
                                <input type="checkbox" id="notify-email" checked>
                                <label for="notify-email">Email notifications</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="notify-sms">
                                <label for="notify-sms">SMS notifications (for critical alerts only)</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="notify-dashboard" checked>
                                <label for="notify-dashboard">Dashboard notifications</label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Alert Categories</label>
                            <div class="checkbox-group">
                                <input type="checkbox" id="alert-adr" checked>
                                <label for="alert-adr">Adverse Drug Reactions</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="alert-recalls" checked>
                                <label for="alert-recalls">Drug Recalls</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="alert-safety" checked>
                                <label for="alert-safety">Safety Advisories</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="alert-interactions" checked>
                                <label for="alert-interactions">Drug Interactions</label>
                            </div>
                        </div>
                        
                        <div class="button-group">
                            <button type="button" class="btn btn-secondary" onclick="resetNotificationForm()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Preferences</button>
                        </div>
                    </form>
                </div>

                <!-- API & Integration Section -->
                <div class="settings-section">
                    <h2>
                        <i data-lucide="code"></i> API & Integration
                    </h2>
                    <div class="info-box">
                        Manage API keys and integration settings for your systems.
                    </div>
                    <form id="api-form" onsubmit="handleApiSubmit(event)">
                        <div class="form-group">
                            <label class="form-label">API Key</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="password" class="form-control" id="api-key" readonly style="flex: 1;">
                                <button type="button" class="btn btn-secondary" onclick="toggleApiKeyVisibility()" style="width: auto;">Show</button>
                                <button type="button" class="btn btn-secondary" onclick="copyApiKey()" style="width: auto;">Copy</button>
                            </div>
                            <p class="form-description">Use this key to authenticate API requests from your systems</p>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Webhook URL (Optional)</label>
                            <input type="url" class="form-control" id="webhook-url" placeholder="https://your-system.com/webhook">
                            <p class="form-description">We'll send real-time safety alerts to this URL</p>
                        </div>
                        
                        <div class="button-group">
                            <button type="button" class="btn btn-secondary" onclick="resetApiForm()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Settings</button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- Success Modal -->
    <div class="success-modal" id="success-modal">
        <div class="modal-content">
            <div class="success-checkmark">
                <svg viewBox="0 0 24 24">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
            </div>
            <h3>Done Successful</h3>
            <p id="success-message">Your settings have been saved successfully</p>
        </div>
    </div>

    <script type="module">
        import { Auth } from '/static/js/auth.js';

        const user = Auth.requireAuth();
        if (!user || user.role !== 'pharma') {
            window.location.href = '/login';
        }

        lucide.createIcons();

        // Load settings on page load
        async function loadSettings() {
            try {
                const response = await fetch('/api/pharma/settings');
                const data = await response.json();
                
                if (data.success) {
                    // Company settings
                    document.getElementById('company-name').value = data.companyName || '';
                    document.getElementById('company-email').value = data.email || '';
                    document.getElementById('company-phone').value = data.phone || '';
                    document.getElementById('company-address').value = data.address || '';
                    document.getElementById('company-registration').value = data.registration || '';
                    
                    // Compliance settings
                    document.getElementById('share-adr-reports').checked = data.shareAdrReports !== false;
                    document.getElementById('share-safety-data').checked = data.shareSafetyData !== false;
                    document.getElementById('anonymize-reports').checked = data.anonymizeReports || false;
                    document.getElementById('regulatory-authority').value = data.regulatoryAuthority || '';
                    document.getElementById('retention-period').value = data.retentionPeriod || '24';
                    
                    // Notification settings
                    document.getElementById('alert-frequency').value = data.alertFrequency || 'immediate';
                    document.getElementById('notify-email').checked = data.notifyEmail !== false;
                    document.getElementById('notify-sms').checked = data.notifySms || false;
                    document.getElementById('notify-dashboard').checked = data.notifyDashboard !== false;
                    document.getElementById('alert-adr').checked = data.alertAdr !== false;
                    document.getElementById('alert-recalls').checked = data.alertRecalls !== false;
                    document.getElementById('alert-safety').checked = data.alertSafety !== false;
                    document.getElementById('alert-interactions').checked = data.alertInteractions !== false;
                    
                    // API settings
                    document.getElementById('api-key').value = data.apiKey || 'pk_live_' + Math.random().toString(36).substr(2, 20);
                    document.getElementById('webhook-url').value = data.webhookUrl || '';
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        window.handleCompanySubmit = async function(e) {
            e.preventDefault();
            
            const data = {
                companyName: document.getElementById('company-name').value,
                phone: document.getElementById('company-phone').value,
                address: document.getElementById('company-address').value,
                registration: document.getElementById('company-registration').value
            };
            
            try {
                const response = await fetch('/api/pharma/settings/company', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.success) {
                    showSuccessModal('Company information saved successfully');
                } else {
                    showError(result.message || 'Failed to save settings');
                }
            } catch (error) {
                showError('Error saving settings: ' + error.message);
            }
        };

        window.handleComplianceSubmit = async function(e) {
            e.preventDefault();
            
            const data = {
                shareAdrReports: document.getElementById('share-adr-reports').checked,
                shareSafetyData: document.getElementById('share-safety-data').checked,
                anonymizeReports: document.getElementById('anonymize-reports').checked,
                regulatoryAuthority: document.getElementById('regulatory-authority').value,
                retentionPeriod: document.getElementById('retention-period').value
            };
            
            try {
                const response = await fetch('/api/pharma/settings/compliance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.success) {
                    showSuccessModal('Compliance preferences saved successfully');
                } else {
                    showError(result.message || 'Failed to save preferences');
                }
            } catch (error) {
                showError('Error saving preferences: ' + error.message);
            }
        };

        window.handleNotificationSubmit = async function(e) {
            e.preventDefault();
            
            const data = {
                alertFrequency: document.getElementById('alert-frequency').value,
                notifyEmail: document.getElementById('notify-email').checked,
                notifySms: document.getElementById('notify-sms').checked,
                notifyDashboard: document.getElementById('notify-dashboard').checked,
                alertAdr: document.getElementById('alert-adr').checked,
                alertRecalls: document.getElementById('alert-recalls').checked,
                alertSafety: document.getElementById('alert-safety').checked,
                alertInteractions: document.getElementById('alert-interactions').checked
            };
            
            try {
                const response = await fetch('/api/pharma/settings/notifications', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.success) {
                    showSuccessModal('Notification preferences saved successfully');
                } else {
                    showError(result.message || 'Failed to save preferences');
                }
            } catch (error) {
                showError('Error saving preferences: ' + error.message);
            }
        };

        window.handleApiSubmit = async function(e) {
            e.preventDefault();
            
            const data = {
                webhookUrl: document.getElementById('webhook-url').value
            };
            
            try {
                const response = await fetch('/api/pharma/settings/api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.success) {
                    showSuccessModal('API settings saved successfully');
                } else {
                    showError(result.message || 'Failed to save settings');
                }
            } catch (error) {
                showError('Error saving settings: ' + error.message);
            }
        };

        window.toggleApiKeyVisibility = function() {
            const apiKeyInput = document.getElementById('api-key');
            const btn = event.target;
            if (apiKeyInput.type === 'password') {
                apiKeyInput.type = 'text';
                btn.textContent = 'Hide';
            } else {
                apiKeyInput.type = 'password';
                btn.textContent = 'Show';
            }
        };

        window.copyApiKey = function() {
            const apiKeyInput = document.getElementById('api-key');
            apiKeyInput.select();
            document.execCommand('copy');
            showSuccessModal('API key copied to clipboard');
        };

        window.resetCompanyForm = function() {
            loadSettings();
        };

        window.resetComplianceForm = function() {
            loadSettings();
        };

        window.resetNotificationForm = function() {
            loadSettings();
        };

        window.resetApiForm = function() {
            loadSettings();
        };

        function showSuccessModal(message) {
            document.getElementById('success-message').textContent = message;
            const modal = document.getElementById('success-modal');
            modal.classList.add('show');
            
            setTimeout(() => {
                modal.classList.remove('show');
            }, 2500);
        }

        function showError(message) {
            const errorBox = document.getElementById('error-box');
            errorBox.textContent = message;
            errorBox.style.display = 'block';
            
            setTimeout(() => {
                errorBox.style.display = 'none';
            }, 5000);
        }

        // Load settings on page load
        loadSettings();
    </script>
</body>
</html>
